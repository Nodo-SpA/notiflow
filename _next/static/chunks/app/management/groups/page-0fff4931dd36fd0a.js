(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[755],{6244:function(e,s,a){Promise.resolve().then(a.bind(a,4022))},4022:function(e,s,a){"use strict";a.r(s),a.d(s,{default:function(){return c}});var r=a(7437),l=a(2265),o=a(7648),t=a(9376),d=a(2840),i=a(7855),n=a(2449);function c(){let e=(0,n.tN)(e=>e.user),s=(0,n.tN)(e=>e.hasPermission),{year:a}=(0,n.GL)(),c=new Date().getFullYear().toString(),u=a||c,m=s("groups.create")||s("groups.update")||s("groups.delete"),x="global"===((null==e?void 0:e.schoolId)||"").toLowerCase();(0,t.useRouter)();let[p,g]=(0,l.useState)([]),[h,v]=(0,l.useState)([]),[b,y]=(0,l.useState)([]),[f,N]=(0,l.useState)({name:"",description:"",memberIds:[],schoolId:""}),[j,I]=(0,l.useState)(!1),[w,S]=(0,l.useState)([]),[C,k]=(0,l.useState)(!1),[M,E]=(0,l.useState)(!1),[G,L]=(0,l.useState)(!1),[_,A]=(0,l.useState)(!1),[B,D]=(0,l.useState)(""),[z,O]=(0,l.useState)(""),[P,q]=(0,l.useState)(""),[F,R]=(0,l.useState)(""),[T,U]=(0,l.useState)(1),[V,Y]=(0,l.useState)(0),[H,J]=(0,l.useState)(!1),[K,Q]=(0,l.useState)(null);(0,l.useEffect)(()=>{m&&(W(),X(),x&&$(),!x&&(null==e?void 0:e.schoolId)&&N(s=>({...s,schoolId:e.schoolId})))},[m,x,e,u]),(0,l.useEffect)(()=>{m&&X()},[f.schoolId,u,m]),(0,l.useEffect)(()=>{let e=setTimeout(()=>R(P.trim()),300);return()=>clearTimeout(e)},[P]),(0,l.useEffect)(()=>{U(1)},[F,x?f.schoolId:null==e?void 0:e.schoolId,u]),(0,l.useEffect)(()=>{m&&ee()},[m,F,T,x,f.schoolId,u]);let W=async()=>{I(!0),D("");try{let e=[],s=1;for(;;){let a=(await i.x.getUsers({page:s,pageSize:100})).data||[];if(e.push(...a),!a.length||a.length<100||(s+=1)>20)break}g(e)}catch(l){var e,s,a,r;D((null==l?void 0:null===(s=l.response)||void 0===s?void 0:null===(e=s.data)||void 0===e?void 0:e.message)||(null==l?void 0:null===(r=l.response)||void 0===r?void 0:null===(a=r.data)||void 0===a?void 0:a.error)||(null==l?void 0:l.message)||"No se pudieron cargar usuarios")}finally{I(!1)}},X=async()=>{let s=x?f.schoolId:null==e?void 0:e.schoolId;if(s){k(!0);try{let e=[],a=1,r=!0;for(;r;){let l=(await i.x.getStudents({page:a,pageSize:500,schoolId:s,year:u})).data||{},o=l.items||[];if(e.push(...o),!(r=!0===l.hasMore&&o.length>0)||o.length<500||(a+=1)>10)break}S(e)}catch(e){}finally{k(!1)}}},Z=(0,l.useMemo)(()=>{let s=[...p.map(e=>({id:e.id,name:e.name,email:e.email,role:e.role,badge:"Usuario"})),...w.filter(s=>{let a=x?f.schoolId:null==e?void 0:e.schoolId;return!a||s.schoolId===a}).map(e=>({id:e.id,name:"".concat(e.firstName||""," ").concat(e.lastNameFather||""," ").concat(e.lastNameMother||"").trim(),email:[e.email,...(e.guardians||[]).map(e=>null==e?void 0:e.email).filter(Boolean)].filter(Boolean)[0],role:e.course||"Alumno",badge:"Alumno"}))];if(!z.trim())return s;let a=z.toLowerCase();return s.filter(e=>{var s,r,l;return(null===(s=e.name)||void 0===s?void 0:s.toLowerCase().includes(a))||(null===(r=e.email)||void 0===r?void 0:r.toLowerCase().includes(a))||(null===(l=e.role)||void 0===l?void 0:l.toLowerCase().includes(a))})},[z,p,w,null==e?void 0:e.schoolId,x,f.schoolId]),$=async()=>{L(!0),D("");try{let e=await i.x.getSchools();y(e.data||[])}catch(l){var e,s,a,r;D((null==l?void 0:null===(s=l.response)||void 0===s?void 0:null===(e=s.data)||void 0===e?void 0:e.message)||(null==l?void 0:null===(r=l.response)||void 0===r?void 0:null===(a=r.data)||void 0===a?void 0:a.error)||(null==l?void 0:l.message)||"No se pudieron cargar colegios")}finally{L(!1)}},ee=async()=>{var e,s,a,r,l,o,t,d,n;E(!0),D("");try{let o=x&&f.schoolId||void 0,t=(await i.x.getGroups(o,u,F||void 0,T,20)).data||{},d=null!==(s=null!==(e=t.items)&&void 0!==e?e:t)&&void 0!==s?s:[];v(d),Y(null!==(r=null!==(a=t.total)&&void 0!==a?a:d.length)&&void 0!==r?r:0),J(null!==(l=t.hasMore)&&void 0!==l&&l)}catch(e){D((null==e?void 0:null===(t=e.response)||void 0===t?void 0:null===(o=t.data)||void 0===o?void 0:o.message)||(null==e?void 0:null===(n=e.response)||void 0===n?void 0:null===(d=n.data)||void 0===d?void 0:d.error)||(null==e?void 0:e.message)||"No se pudieron cargar grupos")}finally{E(!1)}},es=Math.max(1,Math.ceil(V/20));if(!m)return(0,r.jsx)(d.I,{children:(0,r.jsxs)("div",{className:"glass-panel rounded-2xl p-6 soft-shadow",children:[(0,r.jsx)("h1",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Sin permisos"}),(0,r.jsx)("p",{className:"text-gray-600",children:"No tienes permisos para gestionar grupos."})]})});let ea=async s=>{s.preventDefault(),A(!0),D("");try{let s=x?f.schoolId||(null==e?void 0:e.schoolId):(null==e?void 0:e.schoolId)||f.schoolId;if(!s){D("Selecciona colegio para el grupo");return}if(!f.memberIds.length){D("Selecciona al menos un miembro");return}K?await i.x.updateGroup(K,{name:f.name,description:f.description,memberIds:f.memberIds,schoolId:s}):await i.x.createGroup({name:f.name,description:f.description,memberIds:f.memberIds,schoolId:s}),N({name:"",description:"",memberIds:[],schoolId:x?"":s}),Q(null),await ee()}catch(e){var a,r,l,o;D((null==e?void 0:null===(r=e.response)||void 0===r?void 0:null===(a=r.data)||void 0===a?void 0:a.message)||(null==e?void 0:null===(o=e.response)||void 0===o?void 0:null===(l=o.data)||void 0===l?void 0:l.error)||(null==e?void 0:e.message)||"No se pudo guardar el grupo")}finally{A(!1)}},er=s=>{Q(s.id),N({name:s.name,description:s.description||"",memberIds:s.memberIds||[],schoolId:x?s.schoolId:f.schoolId||(null==e?void 0:e.schoolId)||""})},el=()=>{Q(null),N({name:"",description:"",memberIds:[],schoolId:x?"":(null==e?void 0:e.schoolId)||""})},eo=async e=>{A(!0),D("");try{await i.x.deleteGroup(e),K===e&&el(),await ee()}catch(e){var s,a,r,l;D((null==e?void 0:null===(a=e.response)||void 0===a?void 0:null===(s=a.data)||void 0===s?void 0:s.message)||(null==e?void 0:null===(l=e.response)||void 0===l?void 0:null===(r=l.data)||void 0===r?void 0:r.error)||(null==e?void 0:e.message)||"No se pudo eliminar el grupo")}finally{A(!1)}};return(0,r.jsx)(d.I,{children:(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-sm text-gray-500",children:"Gesti\xf3n"}),(0,r.jsx)("h1",{className:"text-4xl font-bold text-gray-900",children:"Grupos"}),(0,r.jsx)("p",{className:"text-gray-600 mt-1",children:"Crea grupos de usuarios para enviar mensajes"})]}),(0,r.jsx)(o.default,{href:"/dashboard",className:"text-primary hover:text-green-800 transition-colors",children:"← Volver"})]}),B&&(0,r.jsx)("div",{className:"p-4 bg-red-50 border border-red-200 text-red-700 rounded-lg text-sm",children:B}),(0,r.jsxs)("div",{className:"glass-panel rounded-2xl soft-shadow p-6 space-y-4",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between flex-wrap gap-3",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h2",{className:"text-xl font-semibold text-gray-900",children:"Nuevo grupo"}),(0,r.jsx)("p",{className:"text-sm text-gray-600",children:"Define nombre, miembros y colegio"})]}),(M||j)&&(0,r.jsx)("span",{className:"text-sm text-gray-500",children:"Cargando..."})]}),(0,r.jsxs)("form",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",onSubmit:ea,children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nombre del grupo"}),(0,r.jsx)("input",{type:"text",value:f.name,onChange:e=>N(s=>({...s,name:e.target.value})),className:"w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent border-gray-200",required:!0})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Descripci\xf3n"}),(0,r.jsx)("input",{type:"text",value:f.description,onChange:e=>N(s=>({...s,description:e.target.value})),className:"w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent border-gray-200",placeholder:"Opcional"})]}),x&&(0,r.jsxs)("div",{className:"md:col-span-2",children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Colegio"}),(0,r.jsxs)("select",{value:f.schoolId,onChange:e=>N(s=>({...s,schoolId:e.target.value})),className:"w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent border-gray-200 bg-white",children:[(0,r.jsx)("option",{value:"",children:"Selecciona colegio"}),b.map(e=>(0,r.jsxs)("option",{value:e.id,children:[e.name," (",e.id,")"]},e.id))]})]}),(0,r.jsxs)("div",{className:"md:col-span-2",children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Miembros"}),(0,r.jsxs)("div",{className:"space-y-2 border border-gray-200 rounded-lg p-3",children:[(0,r.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[(0,r.jsx)("input",{type:"search",value:z,onChange:e=>O(e.target.value),placeholder:"Buscar por nombre, email, curso o rol",className:"w-full sm:w-2/3 px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent border-gray-200"}),(0,r.jsxs)("span",{className:"text-xs text-gray-500",children:[Z.length," resultado(s)"]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 max-h-64 overflow-y-auto pr-1",children:[Z.map(e=>(0,r.jsxs)("label",{className:"flex items-center gap-3 text-sm border border-gray-200 rounded-lg px-3 py-2 hover:border-primary cursor-pointer",children:[(0,r.jsx)("input",{type:"checkbox",checked:f.memberIds.includes(e.id),onChange:s=>{let a=s.target.checked;N(s=>{let r=new Set(s.memberIds);return a?r.add(e.id):r.delete(e.id),{...s,memberIds:Array.from(r)}})}}),(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("p",{className:"text-gray-800 font-medium",children:e.name||"Sin nombre"}),(0,r.jsx)("p",{className:"text-gray-500 text-xs",children:e.email||"Sin correo"}),(0,r.jsx)("p",{className:"text-gray-400 text-xs",children:e.role||"—"})]}),(0,r.jsx)("span",{className:"text-[11px] px-2 py-1 rounded-full border border-gray-200 bg-gray-50 text-gray-600",children:e.badge})]},e.id)),!p.length&&(0,r.jsx)("p",{className:"text-sm text-gray-500",children:"No hay usuarios para seleccionar."}),p.length>0&&!Z.length&&(0,r.jsx)("p",{className:"text-sm text-gray-500",children:"Sin coincidencias para la b\xfasqueda."})]})]})]}),(0,r.jsxs)("div",{className:"md:col-span-2 flex justify-end",children:[(0,r.jsx)("button",{type:"submit",disabled:_,className:"px-4 py-2 bg-primary text-white rounded-lg font-medium hover:bg-primary-dark transition-colors disabled:opacity-60",children:_?"Guardando...":K?"Actualizar grupo":"Crear grupo"}),K&&(0,r.jsx)("button",{type:"button",onClick:el,className:"ml-3 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors",disabled:_,children:"Cancelar"})]})]})]}),(0,r.jsxs)("div",{className:"glass-panel rounded-2xl soft-shadow p-6 space-y-3",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsx)("h2",{className:"text-xl font-semibold text-gray-900",children:"Grupos creados"}),(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)("input",{type:"search",value:P,onChange:e=>{q(e.target.value)},placeholder:"Buscar grupo",className:"w-48 px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent border-gray-200"}),(0,r.jsxs)("span",{className:"text-xs text-gray-500",children:["Mostrando ",h.length," de ",V," grupo(s)"]}),(0,r.jsx)("button",{type:"button",onClick:ee,className:"text-sm text-primary hover:text-green-800",children:"Refrescar"})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[h.map(e=>{var s;return(0,r.jsxs)("div",{className:"border border-gray-200 rounded-lg p-3 hover:shadow-sm transition-shadow",children:[(0,r.jsx)("p",{className:"text-sm font-semibold text-gray-900",children:e.name}),e.description&&(0,r.jsx)("p",{className:"text-xs text-gray-600 mb-1",children:e.description}),(0,r.jsxs)("p",{className:"text-xs text-gray-600",children:["Miembros: ",(null===(s=e.memberIds)||void 0===s?void 0:s.length)||0," • Colegio: ",e.schoolId]}),(0,r.jsxs)("div",{className:"flex gap-2 mt-2",children:[(0,r.jsx)("button",{type:"button",onClick:()=>er(e),className:"text-xs text-primary hover:underline",children:"Editar"}),(0,r.jsx)("span",{className:"text-gray-300",children:"•"}),(0,r.jsx)("button",{type:"button",onClick:()=>eo(e.id),className:"text-xs text-red-600 hover:underline",children:"Eliminar"})]})]},e.id)}),!h.length&&(0,r.jsx)("div",{className:"text-sm text-gray-500",children:"No hay grupos registrados."})]}),(0,r.jsxs)("div",{className:"flex items-center justify-between gap-3",children:[(0,r.jsx)("button",{type:"button",disabled:T<=1,onClick:()=>U(e=>Math.max(1,e-1)),className:"px-3 py-1.5 border border-gray-300 rounded-lg text-sm disabled:opacity-50",children:"Anterior"}),(0,r.jsxs)("span",{className:"text-sm text-gray-600",children:["P\xe1gina ",T," de ",es]}),(0,r.jsx)("button",{type:"button",disabled:T>=es,onClick:()=>U(e=>Math.min(es,e+1)),className:"px-3 py-1.5 border border-gray-300 rounded-lg text-sm disabled:opacity-50",children:"Siguiente"})]})]})]})})}}},function(e){e.O(0,[502,619,648,785,255,462,971,117,744],function(){return e(e.s=6244)}),_N_E=e.O()}]);