(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[739],{4513:function(e,s,a){Promise.resolve().then(a.bind(a,9017))},9017:function(e,s,a){"use strict";a.r(s),a.d(s,{default:function(){return u}});var r=a(7437),t=a(2265),l=a(7648),n=a(1469),o=a(2840),d=a(7855),i=a(2449),c=a(3260);function u(){let e=(0,i.tN)(e=>e.user),s=(0,i.tN)(e=>e.hasPermission),{year:a}=(0,i.GL)(),u=s("students.create")||s("students.update")||s("students.delete"),m=s("students.create"),x=s("students.update"),p="global"===((null==e?void 0:e.schoolId)||"").toLowerCase(),[g,h]=(0,t.useState)(""),[y,f]=(0,t.useState)(""),[b,N]=(0,t.useState)([]),[j,v]=(0,t.useState)(0),[w,C]=(0,t.useState)(!1),[k,S]=(0,t.useState)(""),[I,E]=(0,t.useState)(""),[M,A]=(0,t.useState)(""),[F,_]=(0,t.useState)(!1),[B,D]=(0,t.useState)(1),[q,P]=(0,t.useState)(a||""),[z,G]=(0,t.useState)(!1),[U,L]=(0,t.useState)(null),[O,T]=(0,t.useState)({firstName:"",lastNameFather:"",lastNameMother:"",course:"",run:"",gender:"",email:"",phone:"",commune:"",address:"",guardians:[],schoolId:p?"":(null==e?void 0:e.schoolId)||""});(0,t.useEffect)(()=>{let e=setTimeout(()=>f(g.trim()),300);return()=>clearTimeout(e)},[g]),(0,t.useEffect)(()=>{D(1)},[y,q]),(0,t.useEffect)(()=>{P(a||""),D(1)},[a]),(0,t.useEffect)(()=>{u&&T(s=>({...s,schoolId:p?s.schoolId:(null==e?void 0:e.schoolId)||s.schoolId}))},[u,p,e]);let R=(0,t.useCallback)(async e=>{var s,a,r,t,l,n;if(!u)return;let o=null!=e?e:B;C(!0),S("");try{let e=(await d.x.getStudents({year:q||void 0,page:o,pageSize:50,q:y||void 0})).data||{};N(e.items||[]),v(null!==(a=e.total)&&void 0!==a?a:(null===(s=e.items)||void 0===s?void 0:s.length)||0)}catch(e){S((null==e?void 0:null===(t=e.response)||void 0===t?void 0:null===(r=t.data)||void 0===r?void 0:r.message)||(null==e?void 0:null===(n=e.response)||void 0===n?void 0:null===(l=n.data)||void 0===l?void 0:l.error)||(null==e?void 0:e.message)||"No se pudieron cargar los estudiantes")}finally{C(!1)}},[u,y,B,50,q]);(0,t.useEffect)(()=>{R()},[R]);let K=Math.max(1,Math.ceil(j/50)),Q=()=>{L(null),T({firstName:"",lastNameFather:"",lastNameMother:"",course:"",run:"",gender:"",email:"",phone:"",commune:"",address:"",guardians:[],schoolId:p?"":(null==e?void 0:e.schoolId)||""})},V=async s=>{if(s.preventDefault(),!m&&!x)return;_(!0),E(""),A("");let a=(O.guardians||[]).some(e=>(e.name||"").trim()||(e.email||"").trim()||(e.phone||"").trim());if(!O.firstName.trim()){E("Nombres es obligatorio"),_(!1);return}if(!O.lastNameFather.trim()){E("Apellido paterno es obligatorio"),_(!1);return}if(!O.lastNameMother.trim()){E("Apellido materno es obligatorio"),_(!1);return}if(!O.course.trim()){E("Curso es obligatorio"),_(!1);return}if(!a){E("Debes agregar al menos un apoderado"),_(!1);return}try{let{year:s,...a}=O,r={...a,schoolId:p?O.schoolId||void 0:null==e?void 0:e.schoolId};U?(await d.x.updateStudent(U,r),A("Estudiante actualizado correctamente")):(await d.x.createStudent(r),A("Estudiante creado correctamente"),D(1)),Q(),await R(U?void 0:1),G(!1)}catch(e){var r,t,l,n;E((null==e?void 0:null===(t=e.response)||void 0===t?void 0:null===(r=t.data)||void 0===r?void 0:r.message)||(null==e?void 0:null===(n=e.response)||void 0===n?void 0:null===(l=n.data)||void 0===l?void 0:l.error)||(null==e?void 0:e.message)||"No se pudo guardar el estudiante")}finally{_(!1)}},H=s=>{L(s.id),A(""),E(""),G(!0),T({firstName:s.firstName||"",lastNameFather:s.lastNameFather||"",lastNameMother:s.lastNameMother||"",course:s.course||"",run:s.run||"",gender:s.gender||"",email:s.email||"",phone:s.phone||"",commune:s.commune||"",address:s.address||"",guardians:s.guardians||[],schoolId:p?s.schoolId||"":(null==e?void 0:e.schoolId)||""})},J=e=>{let s=(e||"").replace(/[^0-9kK]/g,"").toUpperCase();if(s.length<=1)return s;let a=s.slice(0,-1),r=s.slice(-1),t=a.replace(/\B(?=(\d{3})+(?!\d))/g,".");return"".concat(t,"-").concat(r)};return u?(0,r.jsxs)(o.I,{children:[(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-sm text-gray-500",children:"Gesti\xf3n escolar"}),(0,r.jsx)("h1",{className:"text-4xl font-bold text-gray-900",children:"Estudiantes"}),(0,r.jsx)("p",{className:"text-gray-600 mt-1",children:"Base de estudiantes activa del colegio"})]}),(0,r.jsx)(l.default,{href:"/dashboard",className:"text-primary hover:text-green-800 transition-colors",children:"← Volver al dashboard"})]}),(0,r.jsxs)("div",{className:"glass-panel rounded-2xl soft-shadow p-6 space-y-4",children:[(0,r.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h2",{className:"text-xl font-semibold text-gray-900",children:"Listado"}),(0,r.jsxs)("p",{className:"text-sm text-gray-600",children:["Mostrando ",b.length," de ",j," estudiantes"]})]}),(0,r.jsxs)("div",{className:"flex flex-col sm:flex-row gap-2 w-full sm:w-auto",children:[(0,r.jsx)("input",{type:"text",value:g,onChange:e=>h(e.target.value),placeholder:"Buscar por nombre, curso o email...",className:"w-full sm:w-80 px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent border-gray-200"}),m&&(0,r.jsx)("button",{type:"button",onClick:()=>{Q(),G(!0)},className:"px-4 py-2 bg-primary text-white rounded-lg font-medium hover:bg-primary-dark transition-colors",children:"+ Nuevo estudiante"})]})]}),w&&(0,r.jsx)("p",{className:"text-sm text-gray-500",children:"Cargando estudiantes..."}),k&&(0,r.jsx)("p",{className:"text-sm text-red-600",children:k}),(0,r.jsx)("div",{className:"overflow-x-auto border border-gray-200 rounded-lg",children:(0,r.jsxs)("table",{className:"min-w-full",children:[(0,r.jsx)("thead",{className:"bg-gray-50 text-left text-sm text-gray-600",children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{className:"px-4 py-3",children:"Estudiante"}),(0,r.jsx)("th",{className:"px-4 py-3",children:"Curso"}),(0,r.jsx)("th",{className:"px-4 py-3",children:"A\xf1o"}),(0,r.jsx)("th",{className:"px-4 py-3",children:"RUN"}),(0,r.jsx)("th",{className:"px-4 py-3",children:"Apoderados"}),(0,r.jsx)("th",{className:"px-4 py-3",children:"Contacto"}),x&&(0,r.jsx)("th",{className:"px-4 py-3",children:"Acciones"})]})}),(0,r.jsxs)("tbody",{className:"divide-y divide-gray-200 text-sm",children:[b.map(e=>(0,r.jsxs)("tr",{className:"hover:bg-gray-50",children:[(0,r.jsx)("td",{className:"px-4 py-3 text-gray-900 font-medium",children:"".concat(e.firstName||""," ").concat(e.lastNameFather||""," ").concat(e.lastNameMother||"").trim()||"—"}),(0,r.jsx)("td",{className:"px-4 py-3 text-gray-700",children:e.course||"—"}),(0,r.jsx)("td",{className:"px-4 py-3 text-gray-700",children:e.year||"—"}),(0,r.jsx)("td",{className:"px-4 py-3 text-gray-700",children:e.run||"—"}),(0,r.jsx)("td",{className:"px-4 py-3 text-gray-700",children:e.guardians&&e.guardians.length?e.guardians.map(e=>e.name||e.email||"Apoderado").slice(0,2).join(", ")+(e.guardians.length>2?" +".concat(e.guardians.length-2):""):"—"}),(0,r.jsx)("td",{className:"px-4 py-3 text-gray-600",children:(0,r.jsxs)("div",{className:"space-y-1",children:[(()=>{let s=[e.email,...(e.guardians||[]).map(e=>e.email).filter(Boolean)].filter(Boolean);return(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(n.Imn,{className:"text-gray-400"}),(0,r.jsx)("span",{className:"truncate",children:s.length?s.join(", "):"Sin correo"})]})})(),e.phone?(0,r.jsxs)("div",{className:"flex items-center gap-2 text-sm",children:[(0,r.jsx)(n.tUt,{className:"text-gray-400"}),(0,r.jsx)("span",{children:e.phone})]}):null,e.commune?(0,r.jsxs)("div",{className:"flex items-center gap-2 text-sm",children:[(0,r.jsx)(n.i63,{className:"text-gray-400"}),(0,r.jsx)("span",{children:e.commune})]}):null,e.address?(0,r.jsxs)("div",{className:"flex items-center gap-2 text-sm",children:[(0,r.jsx)(n.m6D,{className:"text-gray-400"}),(0,r.jsx)("span",{className:"truncate",children:e.address})]}):null]})}),x&&(0,r.jsx)("td",{className:"px-4 py-3 text-right",children:(0,r.jsx)("button",{type:"button",onClick:()=>H(e),className:"text-sm text-primary hover:text-green-800",children:"Editar"})})]},e.id)),!b.length&&(0,r.jsx)("tr",{children:(0,r.jsx)("td",{className:"px-4 py-3 text-gray-500",colSpan:x?7:6,children:"No se encontraron estudiantes con ese criterio."})})]})]})}),(0,r.jsxs)("div",{className:"flex items-center justify-between gap-3",children:[(0,r.jsx)("button",{type:"button",disabled:B<=1,onClick:()=>D(e=>Math.max(1,e-1)),className:"px-3 py-1.5 border border-gray-300 rounded-lg text-sm disabled:opacity-50",children:"Anterior"}),(0,r.jsxs)("span",{className:"text-sm text-gray-600",children:["P\xe1gina ",B," de ",K]}),(0,r.jsx)("button",{type:"button",disabled:B>=K,onClick:()=>D(e=>Math.min(K,e+1)),className:"px-3 py-1.5 border border-gray-300 rounded-lg text-sm disabled:opacity-50",children:"Siguiente"})]})]})]}),(0,r.jsx)(c.u_,{isOpen:z,onClose:()=>{G(!1),Q()},title:U?"Editar estudiante":"Nuevo estudiante",size:"xl",children:(0,r.jsxs)("form",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",onSubmit:V,children:[I&&(0,r.jsx)("div",{className:"md:col-span-2 p-3 bg-red-100 border border-red-300 rounded text-red-700 text-sm",children:I}),M&&(0,r.jsx)("div",{className:"md:col-span-2 p-3 bg-green-50 border border-green-200 rounded text-green-700 text-sm",children:M}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nombres *"}),(0,r.jsx)("input",{type:"text",value:O.firstName,onChange:e=>T(s=>({...s,firstName:e.target.value})),className:"w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent border-gray-200",required:!0})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Apellido paterno *"}),(0,r.jsx)("input",{type:"text",value:O.lastNameFather,onChange:e=>T(s=>({...s,lastNameFather:e.target.value})),className:"w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent border-gray-200",required:!0})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Apellido materno *"}),(0,r.jsx)("input",{type:"text",value:O.lastNameMother,onChange:e=>T(s=>({...s,lastNameMother:e.target.value})),className:"w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent border-gray-200",required:!0})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Curso *"}),(0,r.jsx)("input",{type:"text",value:O.course,onChange:e=>T(s=>({...s,course:e.target.value})),placeholder:"Ej: 4B",className:"w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent border-gray-200",required:!0})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"RUN"}),(0,r.jsx)("input",{type:"text",value:O.run,onChange:e=>T(s=>({...s,run:J(e.target.value)})),placeholder:"11.111.111-1",className:"w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent border-gray-200"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"G\xe9nero"}),(0,r.jsxs)("select",{value:O.gender,onChange:e=>T(s=>({...s,gender:e.target.value})),className:"w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent border-gray-200 bg-white",children:[(0,r.jsx)("option",{value:"",children:"Selecciona"}),(0,r.jsx)("option",{value:"Masculino",children:"Masculino"}),(0,r.jsx)("option",{value:"Femenino",children:"Femenino"}),(0,r.jsx)("option",{value:"Prefiero no decirlo",children:"Prefiero no decirlo"})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Comuna"}),(0,r.jsx)("input",{type:"text",value:O.commune,onChange:e=>T(s=>({...s,commune:e.target.value})),className:"w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent border-gray-200"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Direcci\xf3n"}),(0,r.jsx)("input",{type:"text",value:O.address,onChange:e=>T(s=>({...s,address:e.target.value})),className:"w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent border-gray-200"})]}),(0,r.jsxs)("div",{className:"md:col-span-2 border border-gray-200 rounded-lg p-3",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"Apoderados *"}),(0,r.jsx)("p",{className:"text-xs text-gray-500",children:"Agrega al menos un apoderado (nombre y/o correo)"})]}),(0,r.jsx)("button",{type:"button",onClick:()=>T(e=>({...e,guardians:[...e.guardians||[],{name:"",email:"",phone:""}]})),className:"text-sm text-primary hover:text-primary/80 font-semibold",children:"+ Agregar apoderado"})]}),(0,r.jsxs)("div",{className:"space-y-2",children:[(O.guardians||[]).map((e,s)=>(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2 items-start border border-gray-100 rounded-lg p-2",children:[(0,r.jsx)("div",{children:(0,r.jsx)("input",{type:"text",value:e.name||"",onChange:e=>{let a=e.target.value;T(e=>{let r=[...e.guardians||[]];return r[s]={...r[s],name:a},{...e,guardians:r}})},placeholder:"Nombre",className:"w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent border-gray-200"})}),(0,r.jsx)("div",{children:(0,r.jsx)("input",{type:"email",value:e.email||"",onChange:e=>{let a=e.target.value;T(e=>{let r=[...e.guardians||[]];return r[s]={...r[s],email:a},{...e,guardians:r}})},placeholder:"Correo",className:"w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent border-gray-200"})}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("input",{type:"text",value:e.phone||"",onChange:e=>{let a=e.target.value;T(e=>{let r=[...e.guardians||[]];return r[s]={...r[s],phone:a},{...e,guardians:r}})},placeholder:"Tel\xe9fono",className:"w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent border-gray-200"}),(0,r.jsx)("button",{type:"button",onClick:()=>T(e=>{let a=[...e.guardians||[]];return a.splice(s,1),{...e,guardians:a}}),className:"text-xs text-red-600 hover:underline whitespace-nowrap",children:"Quitar"})]})]},s)),(!O.guardians||0===O.guardians.length)&&(0,r.jsx)("p",{className:"text-xs text-gray-500",children:"Sin apoderados a\xfan. Agrega al menos uno."})]})]}),p&&(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Colegio (ID)"}),(0,r.jsx)("input",{type:"text",value:O.schoolId,onChange:e=>T(s=>({...s,schoolId:e.target.value})),placeholder:"ID de colegio",className:"w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent border-gray-200"})]}),(0,r.jsxs)("div",{className:"md:col-span-2 flex justify-end gap-3",children:[U&&(0,r.jsx)("button",{type:"button",onClick:Q,className:"px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors",disabled:F,children:"Cancelar edici\xf3n"}),(0,r.jsx)("button",{type:"submit",disabled:F,className:"px-4 py-2 bg-primary text-white rounded-lg font-medium hover:bg-primary-dark transition-colors disabled:opacity-60",children:F?"Guardando...":U?"Actualizar estudiante":"Crear estudiante"})]})]})})]}):(0,r.jsx)(o.I,{children:(0,r.jsxs)("div",{className:"glass-panel rounded-2xl p-6 soft-shadow",children:[(0,r.jsx)("h1",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Sin permisos"}),(0,r.jsx)("p",{className:"text-gray-600",children:"No tienes permisos para gestionar estudiantes y apoderados."})]})})}}},function(e){e.O(0,[502,619,648,785,255,462,971,117,744],function(){return e(e.s=4513)}),_N_E=e.O()}]);