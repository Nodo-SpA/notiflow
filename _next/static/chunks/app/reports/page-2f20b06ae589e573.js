(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[882],{8286:function(e,a,t){Promise.resolve().then(t.bind(t,9190))},9190:function(e,a,t){"use strict";t.r(a),t.d(a,{default:function(){return d}});var s=t(7437),l=t(2265),r=t(2840),i=t(7855),n=t(2449);function d(){let{year:e}=(0,n.GL)(),a=(0,n.tN)(e=>e.hasPermission),t=a("reports.view");a("messages.create");let[d,u]=(0,l.useState)([]),[m,x]=(0,l.useState)([]),[v,g]=(0,l.useState)([]),[p,h]=(0,l.useState)("—"),[f,b]=(0,l.useState)({}),[j,N]=(0,l.useState)(!1),[y,w]=(0,l.useState)(""),[E,S]=(0,l.useState)(""),[A,L]=(0,l.useState)(1);(0,l.useEffect)(()=>{t&&(async()=>{var a,t,s,l,r,n,d,o,c,m;N(!0),w("");try{let d=(await i.x.getMessages({year:e})).data||{},o=null!==(l=null!==(s=d.items)&&void 0!==s?s:d)&&void 0!==l?l:[];u(o);let c=async()=>{let e=1,a=[];for(;;){var t,s,l;let r=(await i.x.getUsers({page:e,pageSize:500})).data||{},n=null!==(s=null!==(t=r.items)&&void 0!==t?t:r)&&void 0!==s?s:[];if(!Array.isArray(n)||0===n.length)break;a.push(...n);let d=null!==(l=r.total)&&void 0!==l?l:n.length;if(a.length>=d)break;e++}return a},m=async()=>{let a=1,t=[];for(;;){var s,l,r;let n=(await i.x.getStudents({year:e||void 0,page:a,pageSize:500})).data||{},d=null!==(l=null!==(s=n.items)&&void 0!==s?s:n)&&void 0!==l?l:[];if(!Array.isArray(d)||0===d.length)break;t.push(...d);let o=null!==(r=n.total)&&void 0!==r?r:d.length;if(t.length>=o)break;a++}return t},[v,p]=await Promise.all([c(),m()]);x(v),g(p);let f=await i.x.getUsageMetrics();h(null!==(r=null===(a=f.data)||void 0===a?void 0:a.appActiveUsers)&&void 0!==r?r:"—"),b(null!==(n=null===(t=f.data)||void 0===t?void 0:t.appActiveBySchool)&&void 0!==n?n:{})}catch(e){w((null==e?void 0:null===(o=e.response)||void 0===o?void 0:null===(d=o.data)||void 0===d?void 0:d.message)||(null==e?void 0:null===(m=e.response)||void 0===m?void 0:null===(c=m.data)||void 0===c?void 0:c.error)||(null==e?void 0:e.message)||"No se pudieron cargar los mensajes")}finally{N(!1)}})()},[t,e]);let M=d.filter(e=>{var a,t;let s=E.toLowerCase();return!s||(null===(a=e.content)||void 0===a?void 0:a.toLowerCase().includes(s))||(null===(t=e.senderName)||void 0===t?void 0:t.toLowerCase().includes(s))});M.length,M.slice((A-1)*20,20*A);let k=new Date,C=d.filter(e=>{let a=e.createdAt?new Date(e.createdAt):null;return!(!a||Number.isNaN(a.getTime()))&&a.getMonth()===k.getMonth()&&a.getFullYear()===k.getFullYear()}),I=C.length,U=e=>(e.emailStatus||"").toLowerCase(),D=C.filter(e=>["sent","delivered"].includes(U(e))).length,_=C.filter(e=>"failed"===U(e)).length,z=m.length,F=v.length,P=(0,l.useMemo)(()=>{let e=new Set;return v.forEach(a=>{(a.guardianEmails||[]).forEach(a=>{a&&e.add(a.toLowerCase())}),(a.guardians||[]).forEach(a=>{a.email&&e.add(a.email.toLowerCase())})}),e},[v]).size,T=e=>{let a=(null==e?void 0:e.email)&&""!==e.email.trim(),t=((null==e?void 0:e.guardianEmails)||[]).some(e=>e&&""!==e.trim())||((null==e?void 0:e.guardians)||[]).some(e=>(null==e?void 0:e.email)&&""!==e.email.trim());return a||t},H=v.filter(e=>T(e)).length,O=(0,l.useMemo)(()=>{var e,a;let t="number"==typeof p?p:Number.isFinite(parseInt(p,10))?parseInt(p,10):0,s=((null===(e=n.tN.getState().user)||void 0===e?void 0:e.schoolId)||"").toLowerCase();if(!s)return t;let l=null!==(a=f[s])&&void 0!==a?a:f[s.toLowerCase()];return null!=l?l:t},[p,f]),Y=0===F||0===P?0:O,q=(()=>{let e={sent:0,failed:0,read:0,other:0};return C.forEach(a=>{let t=(a.emailStatus||"").toLowerCase();"sent"===t||"delivered"===t?e.sent++:"read"===t||"opened"===t?e.read++:"failed"===t?e.failed++:e.other++}),e})(),B=(()=>{let e={read:0,pending:0,sent:0,other:0};return C.forEach(a=>{let t=(a.appStatus||"").toLowerCase();"read"===t?e.read++:"pending"===t?e.pending++:"sent"===t||"delivered"===t?e.sent++:e.other++}),e})(),G=B.sent,R=B.read,J=q.read,K=(0,l.useMemo)(()=>{let e=[0,0,0,0],a=new Date;d.forEach(t=>{let s=t.createdAt?new Date(t.createdAt):null;if(!s||Number.isNaN(s.getTime()))return;let l=Math.floor((a.getTime()-s.getTime())/864e5);if(l<0||l>=28)return;let r=Math.floor(l/7);r>=0&&r<4&&(e[r]+=1)});let t=["Semana actual","Hace 1 semana","Hace 2 semanas","Hace 3 semanas"],s=["#0ea5e9","#8b5cf6","#f97316","#10b981"];return e.map((e,a)=>({label:t[a],value:e,color:s[a]})).reverse()},[d]);return t?(0,s.jsx)(r.I,{children:(0,s.jsxs)("div",{className:"space-y-8",children:[(0,s.jsx)("div",{className:"flex items-center justify-between flex-wrap gap-4",children:(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-sm text-gray-500",children:"Anal\xedtica"}),(0,s.jsx)("h1",{className:"text-4xl font-bold text-gray-900",children:"Reportes"}),(0,s.jsxs)("p",{className:"text-gray-600 mt-1",children:["Indicadores de env\xedos y uso (a\xf1o ",e,")"]})]})}),y&&(0,s.jsx)("div",{className:"p-3 rounded-lg border border-red-200 bg-red-50 text-sm text-red-700",children:y}),(0,s.jsxs)("div",{className:"glass-panel rounded-2xl soft-shadow p-5 space-y-3",children:[(0,s.jsx)("div",{className:"flex items-center justify-between",children:(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Mensajer\xeda"}),(0,s.jsx)("h2",{className:"text-lg font-semibold text-gray-900",children:"Indicadores de env\xedos"}),(0,s.jsxs)("p",{className:"text-xs text-gray-500",children:["Datos del mes en curso (",k.toLocaleString("es-CL",{month:"long",year:"numeric"}),")"]})]})}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[(0,s.jsx)(o,{title:"Mensajes totales enviados",value:j?"—":I,accent:"border-indigo-200 bg-indigo-50",text:"text-indigo-800"}),(0,s.jsx)(o,{title:"Email enviados",value:j?"—":D,accent:"border-cyan-200 bg-cyan-50",text:"text-cyan-800"}),(0,s.jsx)(o,{title:"Email le\xeddos",value:j?"—":J,accent:"border-cyan-200 bg-cyan-50",text:"text-cyan-800"}),(0,s.jsx)(o,{title:"Email fallidos",value:j?"—":_,accent:"border-cyan-200 bg-cyan-50",text:"text-cyan-800"}),(0,s.jsx)(o,{title:"App enviados",value:j?"—":G,accent:"border-emerald-200 bg-emerald-50",text:"text-emerald-800"}),(0,s.jsx)(o,{title:"App le\xeddos",value:j?"—":R,accent:"border-emerald-200 bg-emerald-50",text:"text-emerald-800"})]})]}),(0,s.jsxs)("div",{className:"glass-panel rounded-2xl soft-shadow p-5 space-y-3",children:[(0,s.jsx)("div",{className:"flex items-center justify-between",children:(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Usuarios"}),(0,s.jsx)("h2",{className:"text-lg font-semibold text-gray-900",children:"Alcance de la plataforma"})]})}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[(0,s.jsx)(o,{title:"Usuarios totales",value:j?"—":z}),(0,s.jsx)(o,{title:"Estudiantes totales",value:j?"—":F}),(0,s.jsx)(o,{title:"Estudiantes alcanzables (con email)",value:j?"—":H}),(0,s.jsx)(o,{title:"Estudiantes sin email",value:j?"—":Math.max(0,F-H)}),(0,s.jsx)(o,{title:"Apoderados activos en la app (\xfaltimos 30 d\xedas)",value:j?"—":Y})]})]}),(0,s.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[(0,s.jsx)(c,{title:"Uso semanal (\xfaltimas 4 semanas)",subtitle:"Mensajes enviados por semana",data:K}),(0,s.jsx)(c,{title:"Uso de la app en apoderados",subtitle:"Apoderados con email vs apoderados que usaron la app en los \xfaltimos 30 d\xedas",data:[{label:"Apoderados con email",value:P,color:"#0ea5e9"},{label:"Apoderados activos en app (30 d\xedas)",value:Y,color:"#10b981"}]}),(0,s.jsx)(c,{title:"Estado Email",subtitle:"Distribuci\xf3n por canal email",data:[{label:"Enviado",value:q.sent,color:"#10b981"},{label:"Fall\xf3",value:q.failed,color:"#ef4444"},{label:"No se us\xf3 este medio",value:q.other,color:"#94a3b8"}]}),(0,s.jsx)(c,{title:"Estado App",subtitle:"Lecturas y env\xedos en app",data:[{label:"Le\xeddo",value:B.read,color:"#3b82f6"},{label:"Enviado",value:B.sent,color:"#10b981"},{label:"Pendiente",value:B.pending,color:"#f59e0b"},{label:"No se us\xf3 este medio",value:B.other,color:"#94a3b8"}]})]})]})}):(0,s.jsx)(r.I,{children:(0,s.jsxs)("div",{className:"glass-panel rounded-2xl p-6 soft-shadow",children:[(0,s.jsx)("h1",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Sin permisos"}),(0,s.jsx)("p",{className:"text-gray-600",children:"No tienes permisos para ver los reportes."})]})})}function o(e){let{title:a,value:t,accent:l="",text:r="text-gray-900"}=e;return(0,s.jsxs)("div",{className:"glass-panel rounded-2xl p-5 soft-shadow border ".concat(l),children:[(0,s.jsx)("p",{className:"text-sm text-gray-600",children:a}),(0,s.jsx)("div",{className:"mt-2 flex items-baseline gap-2",children:(0,s.jsx)("span",{className:"text-3xl font-bold ".concat(r),children:t})})]})}function c(e){let{title:a,subtitle:t,data:l}=e,r=Math.max(1,...l.map(e=>e.value));return(0,s.jsxs)("div",{className:"glass-panel rounded-2xl p-4 soft-shadow",children:[(0,s.jsxs)("div",{className:"mb-3",children:[(0,s.jsx)("p",{className:"text-xs uppercase tracking-wide text-gray-500",children:a}),t&&(0,s.jsx)("p",{className:"text-sm text-gray-600",children:t})]}),(0,s.jsx)("div",{className:"space-y-2",children:l.map(e=>(0,s.jsxs)("div",{className:"space-y-1",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between text-sm text-gray-700",children:[(0,s.jsxs)("span",{className:"flex items-center gap-2",children:[(0,s.jsx)("span",{className:"w-3 h-3 rounded-full",style:{background:e.color}}),e.label]}),(0,s.jsx)("span",{className:"font-semibold",children:e.value})]}),(0,s.jsx)("div",{className:"h-2 bg-gray-100 rounded-full overflow-hidden",children:(0,s.jsx)("div",{className:"h-full",style:{width:"".concat(e.value/r*100,"%"),background:e.color,transition:"width 0.3s ease"}})})]},e.label))})]})}}},function(e){e.O(0,[502,619,648,785,255,462,971,117,744],function(){return e(e.s=8286)}),_N_E=e.O()}]);