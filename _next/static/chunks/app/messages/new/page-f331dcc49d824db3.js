(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[646],{7348:function(e,s,a){Promise.resolve().then(a.bind(a,9327))},9327:function(e,s,a){"use strict";a.r(s),a.d(s,{default:function(){return x}});var t=a(7437),r=a(2265),l=a(7648),n=a(1994),i=a(2840),o=a(3260),d=a(7855),c=a(2449);let m=e=>e?e.split(/(\*\*[^*]+\*\*|https?:\/\/\S+)/gi).map((e,s)=>{if(!e)return null;let a=/^https?:\/\//i.test(e),r=/^\*\*.+\*\*$/.test(e);if(a)return(0,t.jsx)("a",{href:e,target:"_blank",rel:"noopener noreferrer",className:"text-primary underline break-all",children:e},"url-".concat(s));if(r){let a=e.replace(/^\*\*/,"").replace(/\*\*$/,"");return(0,t.jsx)("strong",{className:"font-semibold",children:a},"bold-".concat(s))}return(0,t.jsx)("span",{children:e},"text-".concat(s))}):null;function x(){let{year:e}=(0,c.GL)(),s=(0,c.tN)(e=>e.hasPermission),a=(0,c.tN)(e=>e.user),x=s("messages.create"),u="teacher"===((null==a?void 0:a.role)||"").toLowerCase(),[p,g]=(0,r.useState)([]),[h,b]=(0,r.useState)([]),[f,y]=(0,r.useState)(!1),[j,v]=(0,r.useState)(null),[N,w]=(0,r.useState)(""),[C,S]=(0,r.useState)(""),[k,E]=(0,r.useState)(""),[M,A]=(0,r.useState)(!1),[L,D]=(0,r.useState)(null),[I,P]=(0,r.useState)(""),[z,T]=(0,r.useState)(""),[F,R]=(0,r.useState)(!1),[B,_]=(0,r.useState)(null),[q,G]=(0,r.useState)(null),[O,V]=(0,r.useState)([]),[U,K]=(0,r.useState)("now"),[Z,H]=(0,r.useState)(""),[W,$]=(0,r.useState)(""),[J,Q]=(0,r.useState)(!1),[X,Y]=(0,r.useState)(""),[ee,es]=(0,r.useState)([]),[ea,et]=(0,r.useState)([]),[er,el]=(0,r.useState)([]),[en,ei]=(0,r.useState)(""),[eo,ed]=(0,r.useState)(""),[ec,em]=(0,r.useState)(""),[ex,eu]=(0,r.useState)(""),[ep,eg]=(0,r.useState)(["email","app"]),[eh,eb]=(0,r.useState)([]),[ef,ey]=(0,r.useState)(!1),[ej,ev]=(0,r.useState)(""),[eN,ew]=(0,r.useState)([]),[eC,eS]=(0,r.useState)(0),[ek,eE]=(0,r.useState)(!1),[eM,eA]=(0,r.useState)(""),[eL,eD]=(0,r.useState)({}),[eI,eP]=(0,r.useState)([]),[ez,eT]=(0,r.useState)(!1),[eF,eR]=(0,r.useState)(""),[eB,e_]=(0,r.useState)(null),[eq,eG]=(0,r.useState)(!1),[eO,eV]=(0,r.useState)([]),[eU,eK]=(0,r.useState)(!1),[eZ,eH]=(0,r.useState)(""),[eW,e$]=(0,r.useState)(""),[eJ,eQ]=(0,r.useState)(1),[eX,eY]=(0,r.useState)(!1),[e0,e1]=(0,r.useState)(""),[e2,e3]=(0,r.useState)(!1),[e5,e4]=(0,r.useState)(0),[e6,e7]=(0,r.useState)(1),[e8,e9]=(0,r.useState)(1),[se,ss]=(0,r.useState)(!1),[sa,st]=(0,r.useState)(!1),[sr,sl]=(0,r.useState)(!1);(0,r.useEffect)(()=>{if(!x)return;let s=async()=>{ey(!0),ev("");try{let e=await d.x.getUsers();eb(e.data||[])}catch(r){var e,s,a,t;ev((null==r?void 0:null===(s=r.response)||void 0===s?void 0:null===(e=s.data)||void 0===e?void 0:e.message)||(null==r?void 0:null===(t=r.response)||void 0===t?void 0:null===(a=t.data)||void 0===a?void 0:a.error)||(null==r?void 0:r.message)||"No se pudieron cargar los usuarios")}finally{ey(!1)}};(async()=>{try{var e;let s=await d.x.getAiPolicy(),a=null==s?void 0:null===(e=s.data)||void 0===e?void 0:e.moderationRules;Array.isArray(a)&&e1(a.join(" • "))}catch(e){}})(),s(),(async()=>{y(!0);try{let e=(await d.x.getTemplates()).data||[];g(e),b(e.slice(0,6))}catch(e){}finally{y(!1)}})(),(async()=>{var s,a,t,r,l,n;eT(!0),eR("");try{let t=(await d.x.getGroups(void 0,e)).data||[];eP(null!==(a=null!==(s=t.items)&&void 0!==s?s:t)&&void 0!==a?a:[])}catch(e){eR((null==e?void 0:null===(r=e.response)||void 0===r?void 0:null===(t=r.data)||void 0===t?void 0:t.message)||(null==e?void 0:null===(n=e.response)||void 0===n?void 0:null===(l=n.data)||void 0===l?void 0:l.error)||(null==e?void 0:e.message)||"No se pudieron cargar los grupos")}finally{eT(!1)}})()},[x,e]),(0,r.useEffect)(()=>{u&&eB&&el(e=>e.filter(e=>eB.includes(e)))},[u,eB]),(0,r.useEffect)(()=>{if(!u||!(null==a?void 0:a.email)){e_(null);return}let e=!0;return eG(!0),d.x.getTeacherPermissions().then(s=>{var t;if(!e)return;let r=Array.isArray(s.data)?s.data:[],l=r.find(e=>{var s;return((null==e?void 0:e.email)||"").toLowerCase()===(null===(s=a.email)||void 0===s?void 0:s.toLowerCase())}),n=(null==l?void 0:l.allowedGroupIds)||(null===(t=r[0])||void 0===t?void 0:t.allowedGroupIds)||[];e_(Array.isArray(n)?n:[])}).catch(()=>{e&&e_([])}).finally(()=>{e&&eG(!1)}),()=>{e=!1}},[u,null==a?void 0:a.email]),(0,r.useEffect)(()=>{if(x&&u&&null!=eB){if(0===eB.length){eV([]),ew([]),eS(0);return}(async()=>{eE(!0),eA("");try{let s=[],a=1,t=!0;for(;t;){let r=(await d.x.getStudents({year:e||void 0,page:a,pageSize:500})).data||{},l=r.items||[];if(s.push(...l),!(t=!0===r.hasMore&&l.length>0)||l.length<500||(a+=1)>10)break}eV(s),eD(e=>{let a={...e};return s.forEach(e=>{a[e.id]=e}),a})}catch(e){var s,a,t,r;eA((null==e?void 0:null===(a=e.response)||void 0===a?void 0:null===(s=a.data)||void 0===s?void 0:s.message)||(null==e?void 0:null===(r=e.response)||void 0===r?void 0:null===(t=r.data)||void 0===t?void 0:t.error)||(null==e?void 0:e.message)||"No se pudieron cargar los estudiantes"),eV([])}finally{eE(!1)}})()}},[x,u,eB,e]),(0,r.useEffect)(()=>{x&&!u&&(async()=>{var s,a,t,r,l,n;eE(!0),eA("");try{let t=(await d.x.getStudents({year:e||void 0,page:e8,pageSize:10,q:ec||void 0})).data||{},r=t.items||[];ew(r),eS(null!==(a=t.total)&&void 0!==a?a:(null===(s=t.items)||void 0===s?void 0:s.length)||0),eD(e=>{let s={...e};return r.forEach(e=>{s[e.id]=e}),s})}catch(e){eA((null==e?void 0:null===(r=e.response)||void 0===r?void 0:null===(t=r.data)||void 0===t?void 0:t.message)||(null==e?void 0:null===(n=e.response)||void 0===n?void 0:null===(l=n.data)||void 0===l?void 0:l.error)||(null==e?void 0:e.message)||"No se pudieron cargar los estudiantes")}finally{eE(!1)}})()},[x,u,e,e8,ec,10]);let sn=e=>new Promise((s,a)=>{let t=new FileReader;t.onload=()=>{let e=t.result;s(e.includes(",")?e.split(",")[1]:e)},t.onerror=a,t.readAsDataURL(e)}),si=async s=>{var t,r,l,n,i,o,c;if(s.preventDefault(),!x)return;if(!W.trim()){eH("Agrega el motivo del mensaje.");return}if(!N.trim()){eH("Escribe el contenido del mensaje.");return}let m=Array.from(new Set([...eh.filter(e=>ee.includes(e.id)).map(e=>e.email).filter(e=>!!e),...ea.map(e=>{var s;return null===(s=eL[e])||void 0===s?void 0:s.email}).filter(e=>!!e),...ea.flatMap(e=>{var s;return((null===(s=eL[e])||void 0===s?void 0:s.guardians)||[]).map(e=>e.email)}).filter(e=>!!e)])),u=er.map(e=>eI.find(s=>s.id===e)).filter(e=>!!e).flatMap(e=>e.memberIds||[]).length>0;if(!m.length){if(er.length>0){if(!u){eH("Los grupos seleccionados no tienen miembros.");return}}else{eH("Selecciona al menos un usuario con correo.");return}}if(!ep.length){eH("Selecciona al menos un canal de env\xedo.");return}if("schedule"===U&&!Z){eH("Selecciona fecha y hora para programar.");return}let p=[];try{if(q){if(q.size>10485760){eH("La imagen supera los 10MB permitidos.");return}let e=await sn(q);p.push({fileName:q.name,mimeType:q.type||"image/*",base64:e,inline:!0,cid:"inline-image-1"})}for(let e of O){if(e.size>10485760){eH("El archivo ".concat(e.name," supera los 10MB permitidos."));return}let s=await sn(e);p.push({fileName:e.name,mimeType:e.type||"application/octet-stream",base64:s,inline:!1})}}catch(e){eH("No se pudieron procesar los adjuntos.");return}let g=1===ee.length?eh.find(e=>e.id===ee[0]):null,h=new Date().toLocaleDateString(),b=e=>{var s,t;return(null!=e?e:"").split("{{nombre}}").join(null!==(s=null==g?void 0:g.name)&&void 0!==s?s:"").split("{{curso}}").join("").split("{{fecha}}").join(h).split("{{remitente}}").join(null!==(t=null==a?void 0:a.name)&&void 0!==t?t:"")},f=b(N),y=b(W);eK(!0),eY(!0),eH(""),e$(""),Y("");let j="schedule"===U&&Z?new Date(Z).toISOString():void 0;try{let e=await d.x.aiRewriteModerate(f,y,"profesional"),s=null===(l=null==e?void 0:null===(t=e.data)||void 0===t?void 0:t.allowed)||void 0===l||l,a=(null==e?void 0:null===(r=e.data)||void 0===r?void 0:r.reasons)||[],n="".concat(f," ").concat(y).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""),i=["odio","racism","xenofob","senofob","discriminac","violencia","acoso","amenaza","insulto","suicidio","matar","golpear","imbecil","imbecil","idiota","estupido","tonto","negro ","maldito"].find(e=>n.includes(e));if(i&&(s=!1,a=[...a,"Posible lenguaje sensible detectado: ".concat(i)]),!s){let e=a.join(" | ")||"Contenido sensible seg\xfan pol\xedticas";eH("IA bloque\xf3 el env\xedo: ".concat(e)),Y("⚠️ IA: ".concat(e)),eK(!1),eY(!1),e3(!0);return}e3(!1),Y(a.length?"Revisi\xf3n IA: ".concat(a.join(" | ")):"Revisi\xf3n IA: sin hallazgos cr\xedticos.")}catch(e){eH((null==e?void 0:null===(i=e.response)||void 0===i?void 0:null===(n=i.data)||void 0===n?void 0:n.message)||(null==e?void 0:null===(c=e.response)||void 0===c?void 0:null===(o=c.data)||void 0===o?void 0:o.error)||(null==e?void 0:e.message)||"No se pudo validar el mensaje con IA"),e3(!0),eK(!1),eY(!1);return}d.x.sendMessage({content:f,recipients:m,channels:ep,scheduleAt:j,year:e,groupIds:er,reason:y,attachments:p}).then(e=>{var s,a;let t=(null==e?void 0:null===(s=e.data)||void 0===s?void 0:s.status)||(null==e?void 0:null===(a=e.data)||void 0===a?void 0:a.messageStatus)||"";if(t&&"failed"===t.toLowerCase()){eH("El backend no pudo entregar el mensaje (estado FAILED). Revisa logs o configuraci\xf3n de correo.");return}e$("now"===U?"Mensaje enviado.":"Mensaje programado."),e3(!1),e4(0),es([]),el([]),et([]),eQ(1),v(null),w(""),H(""),G(null),V([]),$(""),sl(!0),window.scrollTo({top:0,behavior:"smooth"})}).catch(e=>{var s,a,t,r;eH((null==e?void 0:null===(a=e.response)||void 0===a?void 0:null===(s=a.data)||void 0===s?void 0:s.message)||(null==e?void 0:null===(r=e.response)||void 0===r?void 0:null===(t=r.data)||void 0===t?void 0:t.error)||(null==e?void 0:e.message)||"No se pudo enviar el mensaje")}).finally(()=>{eK(!1),eY(!1),(null==eZ?void 0:eZ.toLowerCase().includes("timeout"))&&e3(!1)})},so=e=>{let s=p.find(s=>s.id===e);if(s){if(v(e),w(s.content),$(s.name),s.content.includes("{{fecha}}")){let e=new Date().toLocaleDateString();w(s.content.split("{{fecha}}").join(e))}eQ(2),A(!1)}},sd=e=>{D(e.id),P(e.name),T(e.content),R(!0)},sc=()=>{D(null),P(""),T(""),R(!1)},sm=e=>{_(p.find(s=>s.id===e)||null)},sx=e=>{if(u&&eB&&!eB.includes(e))return;let s=eI.find(s=>s.id===e);if(!s){el(s=>s.includes(e)?s.filter(s=>s!==e):[...s,e]);return}let a=s.memberIds||[];if(a.some(e=>(e||"").includes("@"))){el(s=>s.includes(e)?s.filter(s=>s!==e):[...s,e]);return}let t=a.filter(e=>eL[e]||eN.find(s=>s.id===e)),r=a.filter(e=>!t.includes(e));0!==a.length&&a.every(e=>ee.includes(e)||ea.includes(e))&&er.includes(e)?(es(e=>e.filter(e=>!r.includes(e))),et(e=>e.filter(e=>!t.includes(e))),el(s=>s.filter(s=>s!==e))):(es(e=>Array.from(new Set([...e,...r]))),et(e=>Array.from(new Set([...e,...t]))),el(s=>s.includes(e)?s:[...s,e]))},su=e=>{es(s=>s.includes(e)?s.filter(s=>s!==e):[...s,e])},sp=e=>{et(s=>s.includes(e)?s.filter(s=>s!==e):[...s,e])},sg=e=>((null==e?void 0:e.guardians)||[]).map(e=>(e.email||"").trim()).filter(e=>e.length>0),sh=e=>{if(!e)return"Sin correo";let s=(e.email||"").trim(),a=sg(e);return s||(0===a.length?"Sin correo":1===a.length?a[0]:"".concat(a[0]," (+").concat(a.length-1,")"))},sb=(0,r.useMemo)(()=>{let e=new Map;return eh.forEach(s=>e.set(s.id,s)),e},[eh]),sf=(0,r.useMemo)(()=>{let e={...eL};return eN.forEach(s=>{e[s.id]=s}),e},[eL,eN]),sy=e=>{let s=e.memberIds||[];if(0===s.length)return{count:0,label:"sin miembros"};let a=s.filter(e=>(e||"").includes("@"));if(a.length>0)return{count:new Set(a.map(e=>e.trim().toLowerCase()).filter(Boolean)).size,label:"destinatarios"};let t=new Set;return(s.forEach(e=>{let s=sb.get(e);(null==s?void 0:s.email)&&t.add(s.email.trim().toLowerCase());let a=sf[e];if(a){let e=(a.email||"").trim();e&&t.add(e.toLowerCase()),sg(a).forEach(e=>t.add(e.toLowerCase()))}}),t.size>0)?{count:t.size,label:"destinatarios"}:{count:new Set(s).size,label:"miembros"}},sj=(0,r.useMemo)(()=>{if(!u)return eI;if(!eB)return[];let e=new Set(eB);return eI.filter(s=>e.has(s.id))},[eI,u,eB]),sv=(0,r.useMemo)(()=>{if(!u||!eB)return{ids:new Set,emails:new Set};let e=new Set(eB),s=new Set,a=new Set;return eI.forEach(t=>{e.has(t.id)&&(t.memberIds||[]).forEach(e=>{let t=(e||"").trim();t&&(t.includes("@")?a.add(t.toLowerCase()):s.add(t))})}),{ids:s,emails:a}},[eI,u,eB]),sN=(0,r.useMemo)(()=>{if(!en.trim())return eh;let e=en.toLowerCase();return eh.filter(s=>{var a,t;return(null===(a=s.name)||void 0===a?void 0:a.toLowerCase().includes(e))||(null===(t=s.email)||void 0===t?void 0:t.toLowerCase().includes(e))})},[en,eh]),sw=(0,r.useMemo)(()=>{if(!ex.trim())return sj;let e=ex.toLowerCase();return sj.filter(s=>{var a;return null===(a=s.name)||void 0===a?void 0:a.toLowerCase().includes(e)})},[ex,sj]);(0,r.useEffect)(()=>{e7(1)},[en]),(0,r.useEffect)(()=>{e9(1)},[eo]),(0,r.useEffect)(()=>{e9(1)},[e]),(0,r.useEffect)(()=>{let e=setTimeout(()=>em(eo.trim()),250);return()=>clearTimeout(e)},[eo]),(0,r.useEffect)(()=>{if(!sr)return;let e=setTimeout(()=>sl(!1),5e3);return()=>clearTimeout(e)},[sr]),(0,r.useEffect)(()=>{if(!eW)return;let e=setTimeout(()=>e$(""),5e3);return()=>clearTimeout(e)},[eW]);let sC=(0,r.useMemo)(()=>{if(!u)return[];let e=sv.ids,s=sv.emails,a=eO;e.size||s.size?a=a.filter(a=>{if(!a)return!1;if(e.has(a.id))return!0;let t=(a.email||"").trim().toLowerCase();return!!(t&&s.has(t))||sg(a).map(e=>e.toLowerCase()).some(e=>s.has(e))}):eB&&eB.length>0&&(a=[]);let t=(null==ec?void 0:ec.toLowerCase())||"";return t?a.filter(e=>{let s="".concat(e.firstName||""," ").concat(e.lastNameFather||""," ").concat(e.lastNameMother||"").toLowerCase(),a=(e.email||"").toLowerCase(),r=sg(e).join(" ").toLowerCase(),l=(e.course||"").toLowerCase();return s.includes(t)||a.includes(t)||r.includes(t)||l.includes(t)}):a},[u,eO,sv,ec,eB]),sS=u?sC.length:eC,sk=Math.max(1,Math.ceil(sN.length/12)),sE=(0,r.useMemo)(()=>{let e=(e6-1)*12;return sN.slice(e,e+12)},[sN,e6,12]),sM=Math.max(1,Math.ceil(sS/10)),sA=(0,r.useMemo)(()=>{if(!u)return eN;let e=(e8-1)*10;return sC.slice(e,e+10)},[u,sC,e8,10,eN]),sL=(0,r.useMemo)(()=>eh.filter(e=>ee.includes(e.id)),[eh,ee]),sD=(0,r.useMemo)(()=>eI.filter(e=>er.includes(e.id)),[eI,er]),sI=(0,r.useMemo)(()=>ea.map(e=>eL[e]).filter(Boolean),[ea,eL]),sP=(0,r.useMemo)(()=>[...sL.map(e=>({id:"user-".concat(e.id),label:e.name||e.email,email:e.email,type:"Usuario"})),...sI.map(e=>({id:"student-".concat(e.id),label:"".concat(e.firstName||""," ").concat(e.lastNameFather||""," ").concat(e.lastNameMother||"").trim()||e.email||"Estudiante",email:sh(e),type:"Estudiante (se env\xeda a apoderados)"}))],[sL,sI]),[sz,sT]=(0,r.useState)(""),sF=(0,r.useMemo)(()=>{if(!sz.trim())return sP;let e=sz.toLowerCase();return sP.filter(s=>s.label&&s.label.toLowerCase().includes(e)||s.email&&s.email.toLowerCase().includes(e)||s.type&&s.type.toLowerCase().includes(e))},[sz,sP]),sR=(0,r.useRef)(null),sB=(e,s)=>{let a=sR.current;if(!a)return;let t=a.selectionStart||0,r=a.selectionEnd||0,l=N.slice(0,t),n=N.slice(t,r),i=N.slice(r),o=null!=s?s:e;w("".concat(l).concat(e).concat(n).concat(o).concat(i));let d=t+e.length+n.length+o.length;requestAnimationFrame(()=>{a.focus(),a.setSelectionRange(d,d)})},s_=async()=>{var e,s,a,t,r,l,n,i,o,c,m;if(e5>=3){eH("L\xedmite de 3 usos de IA por mensaje. Ajusta el texto manualmente.");return}if(!N.trim()){eH("Escribe un mensaje para mejorarlo con IA.");return}Q(!0),eH(""),Y("");try{let i=await d.x.aiRewriteModerate(N,W,"profesional y cercano"),o=(null==i?void 0:null===(s=i.data)||void 0===s?void 0:null===(e=s.suggestion)||void 0===e?void 0:e.trim())||N,c=(null==i?void 0:null===(t=i.data)||void 0===t?void 0:null===(a=t.subjectSuggestion)||void 0===a?void 0:a.trim())||W;w(o),$(c);let m=null===(n=null==i?void 0:null===(r=i.data)||void 0===r?void 0:r.allowed)||void 0===n||n,x=(null==i?void 0:null===(l=i.data)||void 0===l?void 0:l.reasons)||[];m?(Y("✅ Sin hallazgos de contenido sensible."),e$("Texto mejorado y aprobado por IA.")):(Y("⚠️ Revisa el texto: ".concat(x.join(", ")||"posible contenido sensible")),eH("La IA detect\xf3 contenido sensible, revisa antes de enviar.")),e4(e=>e+1)}catch(e){eH((null==e?void 0:null===(o=e.response)||void 0===o?void 0:null===(i=o.data)||void 0===i?void 0:i.message)||(null==e?void 0:null===(m=e.response)||void 0===m?void 0:null===(c=m.data)||void 0===c?void 0:c.error)||(null==e?void 0:e.message)||"No pudimos revisar el contenido con IA.")}finally{Q(!1)}};return x?(0,t.jsxs)(i.I,{children:[sr&&(0,t.jsx)("div",{className:"fixed top-16 right-4 z-40",children:(0,t.jsxs)("div",{className:"bg-green-600 text-white shadow-xl rounded-xl px-4 py-3 flex items-center gap-3",children:[(0,t.jsx)("span",{className:"text-lg",children:"✅"}),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"font-semibold leading-tight",children:"Mensaje enviado"}),(0,t.jsx)("p",{className:"text-xs text-green-50 leading-tight",children:"Listo. Puedes redactar otro mensaje."})]}),(0,t.jsx)("button",{type:"button",onClick:()=>sl(!1),className:"ml-2 text-green-50 hover:text-white text-sm",children:"✕"})]})}),(0,t.jsxs)("div",{className:"relative max-w-5xl lg:max-w-6xl mx-auto space-y-6 px-4 sm:px-6",children:[J&&(0,t.jsx)("div",{className:"absolute inset-0 z-30 bg-white/75 backdrop-blur-sm flex flex-col items-center justify-center",children:(0,t.jsxs)("div",{className:"bg-white/90 border border-gray-200 shadow-xl rounded-2xl px-6 py-5 flex flex-col items-center gap-3 max-w-sm text-center",children:[(0,t.jsxs)("div",{className:"relative h-14 w-14",children:[(0,t.jsx)("div",{className:"absolute inset-0 rounded-full border-4 border-primary/20 animate-ping"}),(0,t.jsx)("div",{className:"absolute inset-1 rounded-full border-4 border-primary/30 animate-spin"}),(0,t.jsx)("div",{className:"relative h-full w-full rounded-full bg-primary flex items-center justify-center text-white font-bold",children:"IA"})]}),(0,t.jsx)("p",{className:"text-sm font-semibold text-gray-800",children:"Procesando con IA…"}),(0,t.jsx)("p",{className:"text-xs text-gray-600 leading-relaxed",children:"Mejorando redacci\xf3n, asunto y revisando seguridad. Esto puede tardar unos segundos."})]})}),eX&&(0,t.jsx)("div",{className:"absolute inset-0 z-30 bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center",children:(0,t.jsxs)("div",{className:"bg-white/95 border border-amber-200 shadow-xl rounded-2xl px-6 py-5 flex flex-col items-center gap-3 max-w-sm text-center",children:[(0,t.jsxs)("div",{className:"relative h-14 w-14",children:[(0,t.jsx)("div",{className:"absolute inset-0 rounded-full border-4 border-amber-200 animate-ping"}),(0,t.jsx)("div",{className:"absolute inset-1 rounded-full border-4 border-amber-400 animate-spin"}),(0,t.jsx)("div",{className:"relative h-full w-full rounded-full bg-amber-500 flex items-center justify-center text-white font-bold",children:"IA"})]}),(0,t.jsx)("p",{className:"text-sm font-semibold text-gray-800",children:"Revisando pol\xedticas del colegio…"}),(0,t.jsx)("p",{className:"text-xs text-gray-600 leading-relaxed",children:"Analizando lenguaje sensible y pol\xedticas internas antes de enviar."})]})}),(0,t.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-3 glass-panel rounded-2xl p-4 soft-shadow",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-sm text-gray-500",children:"Redactar"}),(0,t.jsx)("h1",{className:"text-2xl sm:text-3xl font-bold text-gray-900 leading-tight",children:"Nuevo Mensaje"}),(0,t.jsx)("p",{className:"text-gray-600 mt-1",children:"Env\xeda un mensaje inmediato o progr\xe1malo"})]}),(0,t.jsx)(l.default,{href:"/messages",className:"text-primary hover:text-green-800 transition-colors text-sm sm:text-base",children:"← Volver"})]}),(0,t.jsxs)("div",{className:"grid lg:grid-cols-12 gap-4",children:[(0,t.jsxs)("aside",{className:"lg:col-span-3 space-y-3",children:[(0,t.jsxs)("div",{className:"lg:hidden glass-panel rounded-2xl p-3 soft-shadow",children:[(0,t.jsxs)("button",{type:"button",onClick:()=>st(e=>!e),className:"w-full flex items-center justify-between text-sm font-semibold text-gray-800",children:["Pasos del env\xedo",(0,t.jsx)("span",{className:"text-xs text-primary",children:sa?"Ocultar":"Ver"})]}),sa&&(0,t.jsx)("div",{className:"mt-3 space-y-2",children:[{label:"Plantilla",step:1},{label:"Mensaje",step:2},{label:"Destinatarios",step:3},{label:"Canales/Programaci\xf3n",step:4},{label:"Resumen",step:5}].map((e,s)=>(0,t.jsxs)("button",{type:"button",onClick:()=>eQ(e.step),className:(0,n.Z)("w-full flex items-center justify-between rounded-xl border px-3 py-2 text-left transition-all",eJ===e.step?"border-primary bg-primary/10 text-secondary":"border-gray-200 hover:border-primary/40"),children:[(0,t.jsx)("span",{className:"font-semibold text-sm",children:e.label}),(0,t.jsxs)("span",{className:"text-[11px] text-gray-500",children:["Paso ",s+1," / 5"]})]},e.step))})]}),(0,t.jsxs)("div",{className:"hidden lg:block glass-panel rounded-2xl p-4 soft-shadow",children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-gray-500 mb-2",children:"Pasos"}),(0,t.jsx)("div",{className:"space-y-3",children:[{label:"Plantilla",step:1},{label:"Mensaje",step:2},{label:"Destinatarios",step:3},{label:"Canales/Programaci\xf3n",step:4},{label:"Resumen",step:5}].map((e,s)=>{let a=eJ===e.step,r=eJ>e.step;return(0,t.jsxs)("button",{type:"button",onClick:()=>eQ(e.step),className:(0,n.Z)("w-full flex items-center gap-3 rounded-xl border px-3 py-2.5 text-left transition-all",a?"border-primary bg-primary/10 text-secondary shadow-sm":r?"border-green-200 bg-green-50 text-secondary":"border-gray-200 hover:border-primary/40"),children:[(0,t.jsx)("span",{className:(0,n.Z)("h-8 w-8 rounded-full flex items-center justify-center text-sm font-bold",a?"bg-primary text-secondary":r?"bg-green-500 text-white":"bg-gray-100 text-gray-600"),children:e.step}),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-sm font-semibold",children:e.label}),(0,t.jsxs)("p",{className:"text-[11px] text-gray-500",children:["Paso ",s+1," de 5"]})]})]},e.step)})})]}),(0,t.jsxs)("div",{className:"glass-panel rounded-2xl p-4 soft-shadow space-y-2",children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Progreso"}),(0,t.jsx)("div",{className:"h-2 rounded-full bg-gray-100 overflow-hidden",children:(0,t.jsx)("div",{className:"h-full bg-primary transition-all",style:{width:"".concat(eJ/5*100,"%")}})})]})]}),(0,t.jsxs)("div",{className:"lg:col-span-9 glass-panel rounded-2xl soft-shadow p-5 sm:p-8 space-y-6",children:[(eZ||eW)&&(0,t.jsxs)("div",{className:"space-y-2",children:[eZ&&(0,t.jsx)("div",{className:"p-3 bg-red-50 border border-red-200 text-red-700 rounded-lg text-sm",children:eZ}),eW&&(0,t.jsx)("div",{className:"p-3 bg-green-50 border border-green-200 text-green-700 rounded-lg text-sm",children:eW})]}),(0,t.jsxs)("form",{className:"space-y-6",onSubmit:si,children:[1===eJ&&(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-3",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("h2",{className:"text-xl font-semibold text-gray-900",children:"1. Plantillas"}),(0,t.jsx)("p",{className:"text-sm text-gray-600",children:"Aplica o crea mensajes frecuentes."})]}),(0,t.jsx)("button",{type:"button",onClick:()=>A(!0),className:"px-4 py-2 border border-primary text-primary rounded-lg font-medium hover:bg-primary/10 transition-colors",children:"Crear o actualizar plantillas"})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)("p",{className:"text-sm font-semibold text-gray-900",children:"Tus plantillas r\xe1pidas"}),(0,t.jsx)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:p.length>0?p.slice(0,6).map(e=>(0,t.jsxs)("button",{type:"button",onClick:()=>so(e.id),className:"text-left border rounded-lg p-3 hover:border-primary transition-colors ".concat(j===e.id?"border-primary bg-green-50":"border-gray-200"),children:[(0,t.jsx)("p",{className:"font-semibold text-gray-900 mb-1",children:e.name}),(0,t.jsx)("p",{className:"text-sm text-gray-600 line-clamp-2",children:e.content})]},e.id)):(0,t.jsx)("p",{className:"text-sm text-gray-500",children:"No tienes plantillas guardadas todav\xeda."})}),p.length>6&&(0,t.jsx)("p",{className:"text-xs text-gray-500",children:"Ver todas y administrarlas en “Crear o actualizar plantillas”."})]})]}),2===eJ&&(0,t.jsxs)("div",{className:"space-y-4 glass-panel rounded-2xl p-5 soft-shadow",children:[(0,t.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-2",children:[(0,t.jsx)("h2",{className:"text-lg font-semibold text-gray-900",children:"2. Mensaje"}),(0,t.jsxs)("div",{className:"flex flex-wrap items-center gap-2 text-xs text-gray-600",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("span",{children:"Formato r\xe1pido:"}),(0,t.jsx)("button",{type:"button",onClick:()=>sB("**"),className:"px-2 py-1 border border-gray-300 rounded hover:border-primary",children:(0,t.jsx)("span",{className:"font-semibold",children:"B"})}),(0,t.jsx)("button",{type:"button",onClick:()=>sB("_"),className:"px-2 py-1 border border-gray-300 rounded hover:border-primary italic",children:"I"})]}),(0,t.jsx)("div",{className:"h-4 w-px bg-gray-200"}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("button",{type:"button",onClick:s_,disabled:J||e5>=3,className:"px-4 py-2 rounded-full bg-gradient-to-r from-primary to-orange-500 text-white font-semibold shadow-md hover:shadow-lg hover:from-primary-dark hover:to-orange-600 transition-all disabled:opacity-50 disabled:shadow-none flex items-center gap-2",children:J?(0,t.jsxs)("span",{className:"flex items-center gap-1",children:[(0,t.jsx)("span",{className:"animate-spin h-4 w-4 border-2 border-primary border-t-transparent rounded-full"}),"Trabajando..."]}):(0,t.jsx)(t.Fragment,{children:"✨ Mejorar y revisar con IA"})}),(0,t.jsxs)("span",{className:"text-xs font-semibold px-2 py-1 rounded-full border ".concat(e5>=3?"border-red-300 text-red-700 bg-red-50":"border-primary/40 text-primary bg-primary/10"),title:"M\xe1ximo 3 usos de IA por mensaje",children:["Usos de IA: ",e5,"/3"]})]})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Motivo del mensaje"}),(0,t.jsx)("input",{type:"text",value:W,onChange:e=>$(e.target.value),placeholder:"Ej: Aviso de reuni\xf3n, Comunicado general",className:"w-full px-4 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent border-gray-200 bg-white hover:border-gray-300",required:!0})]}),(0,t.jsx)("textarea",{placeholder:"Escribe tu mensaje aqu\xed...",className:"w-full px-4 py-2.5 border rounded-lg font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent border-gray-200 bg-white hover:border-gray-300 h-32 resize-none",value:N,onChange:e=>w(e.target.value),maxLength:1e3,required:!0,ref:sR}),(0,t.jsxs)("div",{className:"border border-gray-200 rounded-lg p-3 bg-gray-50",children:[(0,t.jsx)("p",{className:"text-xs text-gray-500 mb-1",children:"Vista previa (as\xed se ver\xe1 en el correo/app):"}),(0,t.jsx)("div",{className:"text-sm text-gray-800 whitespace-pre-wrap leading-relaxed",children:m(N)||(0,t.jsx)("span",{className:"text-gray-400",children:"Escribe tu mensaje..."})})]}),e0&&(0,t.jsxs)("div",{className:"text-xs text-gray-700 bg-blue-50 border border-blue-200 rounded-lg px-3 py-2",children:[(0,t.jsx)("p",{className:"font-semibold text-blue-800",children:"Pol\xedticas del colegio para IA"}),(0,t.jsx)("p",{className:"text-[11px] text-blue-700 mt-1",children:e0})]}),X&&(0,t.jsx)("div",{className:"text-xs text-amber-700 bg-amber-50 border border-amber-200 rounded-lg px-3 py-2",children:X}),(0,t.jsxs)("div",{className:"rounded-lg border border-dashed border-primary/40 bg-primary/5 p-3 flex flex-col sm:flex-row sm:items-center gap-3",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("div",{className:"w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center text-sm",children:"\uD83D\uDCCE"}),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-sm font-semibold text-gray-900",children:"Adjuntar"}),(0,t.jsx)("p",{className:"text-xs text-gray-600",children:"Im\xe1genes o documentos (m\xe1x 10MB c/u). Hasta 5 archivos."})]})]}),(0,t.jsxs)("div",{className:"flex-1 grid grid-cols-1 sm:grid-cols-2 gap-2",children:[(0,t.jsxs)("label",{className:"text-xs text-gray-700 flex flex-col gap-1",children:["Imagen inline",(0,t.jsx)("input",{type:"file",accept:"image/*",onChange:e=>{var s;return G((null===(s=e.target.files)||void 0===s?void 0:s[0])||null)},className:"text-xs border border-gray-300 rounded-lg px-2 py-1"}),q&&(0,t.jsxs)("span",{className:"text-[11px] text-gray-600",children:[q.name," (",Math.round(q.size/1024)," KB)"]})]}),(0,t.jsxs)("label",{className:"text-xs text-gray-700 flex flex-col gap-1",children:["Documentos (hasta 5)",(0,t.jsx)("input",{type:"file",accept:".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,image/*",multiple:!0,onChange:e=>{let s=Array.from(e.target.files||[]);V(e=>[...e,...s].slice(0,5))},className:"text-xs border border-gray-300 rounded-lg px-2 py-1"}),O.length>0&&(0,t.jsx)("div",{className:"space-y-1 mt-1 max-h-20 overflow-auto",children:O.map((e,s)=>(0,t.jsxs)("div",{className:"flex items-center justify-between text-[11px] text-gray-600 border border-gray-200 rounded px-2 py-1 bg-white",children:[(0,t.jsxs)("span",{className:"truncate",children:[e.name," (",Math.round(e.size/1024)," KB)"]}),(0,t.jsx)("button",{type:"button",onClick:()=>V(e=>e.filter((e,a)=>a!==s)),className:"text-red-500 text-xs ml-2 hover:text-red-700",children:"✕"})]},"".concat(e.name,"-").concat(s)))})]})]})]}),(0,t.jsx)("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-3 text-xs text-gray-600",children:(0,t.jsxs)("span",{className:"text-gray-500",children:[N.length," / 1000 caracteres"]})})]}),3===eJ&&(0,t.jsxs)("div",{className:"space-y-3 glass-panel rounded-2xl p-4 soft-shadow",children:[(0,t.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-2",children:[(0,t.jsx)("h2",{className:"text-lg font-semibold text-gray-900",children:"3. Destinatarios"}),(ee.length>0||ea.length>0||er.length>0)&&(0,t.jsxs)("span",{className:"text-xs text-gray-600",children:[ee.length+ea.length," persona(s) • ",er.length," grupo(s)"]})]}),(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"glass-panel rounded-xl p-4 soft-shadow space-y-3",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between gap-3",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Grupos"}),(0,t.jsx)("p",{className:"text-sm font-semibold text-gray-900",children:"Selecciona grupos"})]}),(0,t.jsxs)("span",{className:"text-xs text-gray-500",children:[sw.length," encontrados"]})]}),(0,t.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2",children:[(0,t.jsx)("input",{type:"search",value:ex,onChange:e=>eu(e.target.value),placeholder:"Buscar grupo",className:"w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent border-gray-200"}),(0,t.jsxs)("span",{className:"text-xs text-gray-500",children:["Seleccionados: ",er.length]})]}),(ez||eq)&&(0,t.jsx)("p",{className:"text-sm text-gray-500",children:"Cargando grupos..."}),eF&&(0,t.jsx)("p",{className:"text-sm text-red-600",children:eF}),!ez&&!eF&&(0,t.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2",children:[sw.map(e=>(0,t.jsxs)("label",{className:"flex items-center gap-2 text-sm text-gray-700 border rounded-lg px-3 py-2 cursor-pointer transition ".concat(er.includes(e.id)?"border-primary bg-primary/10":"border-gray-200 hover:border-primary"),children:[(0,t.jsx)("input",{type:"checkbox",className:"text-primary",checked:er.includes(e.id),onChange:()=>sx(e.id)}),(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("p",{className:"font-medium text-gray-900",children:e.name}),(()=>{let s=sy(e);return"sin miembros"===s.label?(0,t.jsx)("p",{className:"text-xs text-gray-500",children:"Sin miembros"}):(0,t.jsxs)("p",{className:"text-xs text-gray-500",children:[s.count," ",s.label]})})()]})]},e.id)),!sj.length&&(0,t.jsx)("p",{className:"text-sm text-gray-500 col-span-2",children:"No hay grupos disponibles."}),sj.length>0&&!sw.length&&(0,t.jsx)("p",{className:"text-sm text-gray-500 col-span-2",children:"Sin coincidencias para la b\xfasqueda."})]})]}),(0,t.jsxs)("div",{className:"glass-panel rounded-xl p-4 soft-shadow space-y-3",children:[(0,t.jsxs)("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-3",children:[(0,t.jsxs)("div",{className:"w-full",children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Estudiantes"}),(0,t.jsx)("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2",children:(0,t.jsx)("input",{type:"search",value:eo,onChange:e=>ed(e.target.value),placeholder:"Buscar por nombre, curso o email",className:"w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent border-gray-200"})})]}),(0,t.jsxs)("div",{className:"text-xs text-gray-500 flex flex-col items-start sm:items-end",children:[(0,t.jsxs)("span",{children:[sS," total"]}),(0,t.jsxs)("span",{children:["Mostrando p\xe1gina ",e8," de ",sM]})]})]}),ek&&(0,t.jsx)("p",{className:"text-sm text-gray-500",children:"Cargando estudiantes..."}),eM&&(0,t.jsx)("p",{className:"text-sm text-red-600",children:eM}),!ek&&!eM&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-72 overflow-auto pr-1",children:[sA.map(e=>(0,t.jsxs)("label",{className:"flex items-center gap-2 text-sm text-gray-700 border rounded-lg px-3 py-2 cursor-pointer transition ".concat(ea.includes(e.id)?"border-primary bg-primary/10":"border-gray-200 hover:border-primary"),children:[(0,t.jsx)("input",{type:"checkbox",className:"text-primary",checked:ea.includes(e.id),onChange:()=>sp(e.id)}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"font-medium text-gray-900 truncate",children:"".concat(e.firstName||""," ").concat(e.lastNameFather||""," ").concat(e.lastNameMother||"").trim()||"Sin nombre"}),(0,t.jsxs)("p",{className:"text-xs text-gray-500 truncate",children:[sh(e)," ",e.course?"• ".concat(e.course):""," ",e.year?"• ".concat(e.year):""]})]})]},e.id)),!eN.length&&(0,t.jsx)("p",{className:"text-sm text-gray-500 col-span-2",children:"No hay estudiantes disponibles."}),sS>0&&!sA.length&&(0,t.jsx)("p",{className:"text-sm text-gray-500 col-span-2",children:"Sin coincidencias para la b\xfasqueda."})]}),(0,t.jsxs)("div",{className:"flex items-center justify-between gap-3 text-sm text-gray-600",children:[(0,t.jsx)("button",{type:"button",disabled:e8<=1,onClick:()=>e9(e=>Math.max(1,e-1)),className:"px-3 py-1.5 border border-gray-300 rounded-lg disabled:opacity-50",children:"Anterior"}),(0,t.jsxs)("span",{children:["P\xe1gina ",e8," de ",sM]}),(0,t.jsx)("button",{type:"button",disabled:e8>=sM,onClick:()=>e9(e=>Math.min(sM,e+1)),className:"px-3 py-1.5 border border-gray-300 rounded-lg disabled:opacity-50",children:"Siguiente"})]})]})]}),(0,t.jsxs)("div",{className:"glass-panel rounded-xl p-4 soft-shadow space-y-3",children:[(0,t.jsxs)("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-3",children:[(0,t.jsxs)("div",{className:"w-full",children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Usuarios"}),(0,t.jsx)("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2",children:(0,t.jsx)("input",{type:"search",value:en,onChange:e=>ei(e.target.value),placeholder:"Buscar por nombre o email",className:"w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent border-gray-200"})})]}),(0,t.jsxs)("div",{className:"text-xs text-gray-500 flex flex-col items-start sm:items-end",children:[(0,t.jsxs)("span",{children:[sN.length," resultado(s)"]}),(0,t.jsxs)("span",{children:["Mostrando p\xe1gina ",e6," de ",sk]})]})]}),ef&&(0,t.jsx)("p",{className:"text-sm text-gray-500",children:"Cargando usuarios..."}),ej&&(0,t.jsx)("p",{className:"text-sm text-red-600",children:ej}),!ef&&!ej&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-72 overflow-auto pr-1",children:[sE.map(e=>(0,t.jsxs)("label",{className:"flex items-center gap-2 text-sm text-gray-700 border rounded-lg px-3 py-2 cursor-pointer transition ".concat(ee.includes(e.id)?"border-primary bg-primary/10":"border-gray-200 hover:border-primary"),children:[(0,t.jsx)("input",{type:"checkbox",className:"text-primary",checked:ee.includes(e.id),onChange:()=>su(e.id)}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"font-medium text-gray-900 truncate",children:e.name}),(0,t.jsx)("p",{className:"text-xs text-gray-500 truncate",children:e.email})]})]},e.id)),!eh.length&&(0,t.jsx)("p",{className:"text-sm text-gray-500 col-span-2",children:"No hay usuarios disponibles."}),eh.length>0&&!sN.length&&(0,t.jsx)("p",{className:"text-sm text-gray-500 col-span-2",children:"Sin coincidencias para la b\xfasqueda."})]}),(0,t.jsxs)("div",{className:"flex items-center justify-between gap-3 text-sm text-gray-600",children:[(0,t.jsx)("button",{type:"button",disabled:e6<=1,onClick:()=>e7(e=>Math.max(1,e-1)),className:"px-3 py-1.5 border border-gray-300 rounded-lg disabled:opacity-50",children:"Anterior"}),(0,t.jsxs)("span",{children:["P\xe1gina ",e6," de ",sk]}),(0,t.jsx)("button",{type:"button",disabled:e6>=sk,onClick:()=>e7(e=>Math.min(sk,e+1)),className:"px-3 py-1.5 border border-gray-300 rounded-lg disabled:opacity-50",children:"Siguiente"})]})]})]}),(0,t.jsxs)("div",{className:"glass-panel rounded-xl p-3 soft-shadow space-y-2",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between gap-3",children:[(0,t.jsxs)("div",{className:"space-y-0.5",children:[(0,t.jsxs)("p",{className:"font-semibold text-gray-900 text-sm",children:["Destinatarios seleccionados (",sP.length+er.length,")"]}),!!(sP.length+er.length)&&(0,t.jsxs)("p",{className:"text-xs text-gray-500",children:["Grupos: ",sD.length," • Personas: ",sP.length]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2 text-xs",children:[sP.length+er.length>0&&(0,t.jsx)("input",{type:"search",value:sz,onChange:e=>sT(e.target.value),placeholder:"Buscar y quitar destinatario",className:"px-2.5 py-1 rounded-lg border border-gray-300 text-xs w-48"}),!!(sP.length+er.length)&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("button",{type:"button",className:"text-primary hover:text-primary-dark",onClick:()=>ss(e=>!e),children:se?"Colapsar":"Ver todos"}),(0,t.jsx)("button",{type:"button",className:"text-red-600 hover:text-red-700",onClick:()=>{es([]),et([]),el([]),ss(!1),sT("")},children:"Limpiar"})]})]})]}),(0,t.jsxs)("div",{className:"max-h-64 overflow-y-auto space-y-2 pr-1",children:[sD.map(e=>(0,t.jsxs)("span",{className:"inline-flex items-center gap-2 px-3 py-1 rounded-full bg-primary/10 text-primary text-xs border border-primary/30",children:[(0,t.jsx)("span",{className:"font-semibold truncate",children:e.name}),(0,t.jsx)("span",{className:"text-[10px] bg-primary/20 text-primary px-1.5 py-0.5 rounded",children:"Grupo"}),(0,t.jsx)("button",{type:"button",className:"text-primary hover:text-primary-dark",onClick:()=>sx(e.id),"aria-label":"Eliminar grupo",children:"✕"})]},"group-".concat(e.id))),(sz.trim()?sF:se?sP:sP.slice(0,60)).map(e=>{let s=e.email&&e.email.length>24?e.email.slice(0,21)+"…":e.email||"Sin correo";return(0,t.jsxs)("span",{className:"inline-flex items-center gap-2 px-2.5 py-1 rounded-full border border-gray-200 bg-white text-xs shadow-[0_1px_2px_rgba(0,0,0,0.04)]",children:[(0,t.jsx)("span",{className:"font-semibold truncate max-w-[120px] sm:max-w-[150px]",children:e.label}),(0,t.jsx)("span",{className:"text-gray-500 truncate max-w-[140px]",children:s}),(0,t.jsx)("span",{className:"text-[10px] text-blue-700 bg-blue-50 px-1.5 py-0.5 rounded-full border border-blue-100",children:e.type}),(0,t.jsx)("button",{type:"button",className:"text-gray-400 hover:text-red-600 text-[11px]",onClick:()=>{e.id.startsWith("user-")?su(e.id.replace("user-","")):sp(e.id.replace("student-",""))},"aria-label":"Eliminar destinatario",children:"✕"})]},e.id)}),!sP.length&&!sD.length&&(0,t.jsx)("span",{className:"text-xs text-gray-500",children:"A\xfan no seleccionas destinatarios."}),sP.length>60&&!se&&(0,t.jsxs)("button",{type:"button",className:"text-xs text-primary underline",onClick:()=>ss(!0),children:["Ver los ",sP.length," destinatarios"]})]})]})]})]}),4===eJ&&(0,t.jsxs)("div",{className:"space-y-4 glass-panel rounded-2xl p-4 soft-shadow",children:[(0,t.jsx)("h2",{className:"text-lg font-semibold text-gray-900",children:"4. Canales y programaci\xf3n"}),(0,t.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[(0,t.jsxs)("label",{className:"flex items-center gap-2 border rounded-lg px-3 py-2 cursor-pointer transition ".concat(ep.includes("email")?"border-primary bg-green-50":"border-gray-200 hover:border-primary"),children:[(0,t.jsx)("input",{type:"checkbox",name:"channel-email",value:"email",checked:ep.includes("email"),onChange:e=>{let s=e.target.checked;eg(e=>{let a=new Set(e);return s?a.add("email"):a.delete("email"),Array.from(a)})},className:"text-primary"}),(0,t.jsxs)("span",{className:"flex items-center gap-1",children:[(0,t.jsx)("span",{className:"text-lg",children:"\uD83D\uDCE7"}),(0,t.jsx)("span",{children:"Email"})]})]}),(0,t.jsxs)("label",{className:"flex items-center gap-2 border rounded-lg px-3 py-2 cursor-pointer transition ".concat(ep.includes("app")?"border-primary bg-green-50":"border-gray-200 hover:border-primary"),children:[(0,t.jsx)("input",{type:"checkbox",name:"channel-app",value:"app",checked:ep.includes("app"),onChange:e=>{let s=e.target.checked;eg(e=>{let a=new Set(e);return s?a.add("app"):a.delete("app"),Array.from(a)})},className:"text-primary"}),(0,t.jsxs)("span",{className:"flex items-center gap-1",children:[(0,t.jsx)("span",{className:"text-lg",children:"\uD83D\uDCF2"}),(0,t.jsx)("span",{children:"Notiflow App"})]})]})]}),(0,t.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[(0,t.jsxs)("label",{className:"flex items-start gap-3 border rounded-lg p-3 cursor-pointer hover:border-primary transition",children:[(0,t.jsx)("input",{type:"radio",name:"schedule",value:"now",checked:"now"===U,onChange:()=>K("now"),className:"w-4 h-4 text-primary mt-1"}),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"font-medium text-gray-900",children:"Enviar ahora"}),(0,t.jsx)("p",{className:"text-sm text-gray-600",children:"Salida inmediata a los canales seleccionados."})]})]}),(0,t.jsxs)("label",{className:"flex items-start gap-3 border rounded-lg p-3 cursor-pointer hover:border-primary transition",children:[(0,t.jsx)("input",{type:"radio",name:"schedule",value:"schedule",checked:"schedule"===U,onChange:()=>K("schedule"),className:"w-4 h-4 text-primary mt-1"}),(0,t.jsxs)("div",{className:"w-full",children:[(0,t.jsx)("p",{className:"font-medium text-gray-900",children:"Programar"}),(0,t.jsx)("p",{className:"text-sm text-gray-600 mb-2",children:"Define fecha y hora para enviar."}),"schedule"===U&&(0,t.jsx)("input",{type:"datetime-local",value:Z,onChange:e=>H(e.target.value),className:"w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent border-gray-200",required:!0})]})]})]})]}),5===eJ&&(0,t.jsxs)("div",{className:"space-y-3 glass-panel rounded-2xl p-4 soft-shadow",children:[(0,t.jsx)("h2",{className:"text-lg font-semibold text-secondary",children:"5. Resumen"}),(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3",children:[(0,t.jsxs)("div",{className:"glass-panel rounded-xl p-3",children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Motivo"}),(0,t.jsx)("p",{className:"text-base font-semibold text-secondary",children:W||"—"})]}),(0,t.jsxs)("div",{className:"glass-panel rounded-xl p-3",children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Canales"}),(0,t.jsx)("div",{className:"flex flex-wrap gap-2 mt-1",children:ep.map(e=>(0,t.jsx)("span",{className:"pill bg-primary/20 border border-primary/30 text-secondary",children:"email"===e?"Email":"Notiflow App"},e))})]}),(0,t.jsxs)("div",{className:"glass-panel rounded-xl p-3",children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Programaci\xf3n"}),(0,t.jsx)("p",{className:"text-sm text-gray-800 font-semibold",children:"now"===U?"Enviar ahora":Z?"Programado para ".concat(Z):"—"})]})]}),(0,t.jsxs)("div",{className:"glass-panel rounded-xl p-4 space-y-2",children:[(0,t.jsx)("p",{className:"text-sm font-semibold text-secondary",children:"Contenido"}),(0,t.jsx)("div",{className:"text-gray-800 whitespace-pre-wrap leading-relaxed",children:m(N)||"—"})]}),(0,t.jsxs)("div",{className:"glass-panel rounded-xl p-4 space-y-2",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsxs)("p",{className:"text-sm font-semibold text-secondary",children:["Destinatarios (",sP.length+sD.length,")"]}),(0,t.jsxs)("span",{className:"pill bg-primary/15 border border-primary/30 text-secondary",children:["Grupos: ",sD.length]}),(0,t.jsxs)("span",{className:"pill bg-blue-50 border border-blue-100 text-blue-700",children:["Personas: ",sP.length]})]}),(0,t.jsxs)("div",{className:"flex flex-wrap gap-2 mt-1",children:[sD.map(e=>(0,t.jsxs)("span",{className:"px-3 py-1 rounded-full bg-primary/10 text-primary text-xs font-semibold border border-primary/20",children:[e.name||e.id," • Grupo"]},"summary-group-".concat(e.id))),sP.map(e=>{let s=e.id.startsWith("student-")?"".concat(e.label||"Estudiante"," • apoderado: ").concat(e.email||"Sin correo"):e.email||e.label;return(0,t.jsx)("span",{className:"px-3 py-1 rounded-full bg-blue-50 text-blue-700 text-xs font-semibold border border-blue-100 max-w-full truncate",title:s,children:s},e.id)}),!sP.length&&!sD.length&&(0,t.jsx)("span",{className:"text-gray-500 text-xs",children:"Sin destinatarios"})]})]}),(0,t.jsxs)("div",{className:"glass-panel rounded-xl p-4 space-y-2",children:[(0,t.jsx)("p",{className:"text-sm font-semibold text-secondary",children:"Adjuntos"}),(0,t.jsxs)("ul",{className:"list-disc list-inside text-gray-700 space-y-1",children:[q?(0,t.jsxs)("li",{children:["Imagen inline: ",q.name," (",Math.round(q.size/1024)," KB)"]}):(0,t.jsx)("li",{children:"Sin imagen inline"}),O.length>0?O.map((e,s)=>(0,t.jsxs)("li",{children:["Archivo: ",e.name," (",Math.round(e.size/1024)," KB)"]},"".concat(e.name,"-").concat(s))):(0,t.jsx)("li",{children:"Sin otros archivos"})]})]})]})]}),(0,t.jsxs)("div",{className:"flex flex-col sm:flex-row gap-3 pt-1",children:[eJ>1&&(0,t.jsx)("button",{type:"button",onClick:()=>{eH(""),eQ(e=>Math.max(1,e-1))},className:"w-full sm:flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50 transition-colors",children:"← Anterior"}),eJ<5&&(0,t.jsx)("button",{type:"button",onClick:()=>{if(1===eJ){eQ(2);return}if(2===eJ){if(!W.trim()||!N.trim()){eH("Completa motivo y contenido antes de continuar.");return}eH(""),eQ(3);return}if(3===eJ){if(!(ee.length>0||ea.length>0||er.length>0)){eH("Selecciona al menos un destinatario.");return}eH(""),eQ(4);return}if(4===eJ){if(!ep.length){eH("Selecciona al menos un canal de env\xedo.");return}if("schedule"===U&&!Z){eH("Selecciona fecha y hora para programar.");return}eH(""),eQ(5);return}},className:"w-full sm:flex-1 px-6 py-3 bg-primary text-white rounded-lg font-semibold hover:bg-primary-dark transition-colors",children:"Siguiente →"}),5===eJ&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("button",{type:"submit",disabled:eU||e2,className:"w-full sm:flex-1 px-6 py-3 bg-primary text-white rounded-lg font-semibold transition-colors ".concat(eU||e2?"opacity-70 cursor-not-allowed":"hover:bg-primary-dark"),children:eU?"Enviando...":"now"===U?"Enviar Mensaje":"Programar Mensaje"}),(0,t.jsx)(l.default,{href:"/messages",className:"w-full sm:flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50 transition-colors text-center",children:"Cancelar"})]})]})]})]})]})]}),(0,t.jsx)(o.u_,{isOpen:M,title:"Seleccionar plantilla",size:"xl",onClose:()=>A(!1),onConfirm:()=>A(!1),confirmText:"Cerrar",children:(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsx)("p",{className:"text-sm text-gray-600",children:"Elige una plantilla para rellenar el mensaje o crea una nueva."}),(0,t.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-72 overflow-auto pr-1",children:[p.map(e=>(0,t.jsxs)("button",{type:"button",onClick:()=>{so(e.id),A(!1)},className:"text-left border rounded-lg p-3 hover:border-primary transition-colors ".concat(j===e.id?"border-primary bg-green-50":"border-gray-200"),children:[(0,t.jsx)("p",{className:"font-semibold text-gray-900 mb-1",children:e.name}),(0,t.jsx)("p",{className:"text-sm text-gray-600 line-clamp-3",children:e.content}),(0,t.jsxs)("div",{className:"flex items-center gap-2 mt-2",children:[(0,t.jsx)("button",{type:"button",onClick:s=>{s.stopPropagation(),sd(e)},className:"text-xs text-primary hover:underline",children:"Editar"}),(0,t.jsx)("span",{className:"text-gray-300",children:"•"}),(0,t.jsx)("button",{type:"button",onClick:s=>{s.stopPropagation(),sm(e.id)},className:"text-xs text-red-600 hover:underline",children:"Borrar"})]})]},e.id)),!p.length&&(0,t.jsx)("p",{className:"text-sm text-gray-500 col-span-2",children:"No hay plantillas a\xfan."})]}),(0,t.jsxs)("div",{className:"border border-dashed border-gray-300 rounded-xl p-4 sm:p-5 bg-gray-50/70 shadow-sm grid grid-cols-1 gap-4 sm:grid-cols-2 sm:gap-5",children:[(0,t.jsxs)("div",{className:"sm:col-span-2 space-y-3",children:[(0,t.jsx)("p",{className:"font-semibold text-gray-900 text-sm",children:"Atajos r\xe1pidos (rellenan el texto):"}),(0,t.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm",children:[(0,t.jsxs)("button",{type:"button",onClick:()=>E(e=>e+"{{nombre}}"),className:"flex items-center justify-between px-3 py-2 border border-gray-200 rounded-lg hover:border-primary transition",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("span",{className:"text-base",children:"\uD83D\uDC64"}),(0,t.jsxs)("div",{className:"text-left",children:[(0,t.jsx)("p",{className:"font-semibold text-gray-900 text-sm",children:"Nombre de destinatario"}),(0,t.jsx)("p",{className:"text-xs text-gray-500",children:"Inserta el nombre"})]})]}),(0,t.jsx)("span",{className:"text-xs text-gray-500",children:"{{nombre}}"})]}),(0,t.jsxs)("button",{type:"button",onClick:()=>E(e=>e+"{{curso}}"),className:"flex items-center justify-between px-3 py-2 border border-gray-200 rounded-lg hover:border-primary transition",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("span",{className:"text-base",children:"\uD83C\uDFEB"}),(0,t.jsxs)("div",{className:"text-left",children:[(0,t.jsx)("p",{className:"font-semibold text-gray-900 text-sm",children:"Curso / nivel"}),(0,t.jsx)("p",{className:"text-xs text-gray-500",children:"Curso del alumno"})]})]}),(0,t.jsx)("span",{className:"text-xs text-gray-500",children:"{{curso}}"})]}),(0,t.jsxs)("button",{type:"button",onClick:()=>E(e=>e+"{{fecha}}"),className:"flex items-center justify-between px-3 py-2 border border-gray-200 rounded-lg hover:border-primary transition",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("span",{className:"text-base",children:"\uD83D\uDCC5"}),(0,t.jsxs)("div",{className:"text-left",children:[(0,t.jsx)("p",{className:"font-semibold text-gray-900 text-sm",children:"Fecha actual"}),(0,t.jsx)("p",{className:"text-xs text-gray-500",children:"Fecha de env\xedo"})]})]}),(0,t.jsx)("span",{className:"text-xs text-gray-500",children:"{{fecha}}"})]})]})]}),(0,t.jsxs)("div",{className:"sm:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nombre de plantilla"}),(0,t.jsx)("input",{type:"text",value:C,onChange:e=>S(e.target.value),placeholder:"Ej: Comunicado general, Aviso feriado",className:"w-full px-4 py-3 border rounded-lg text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent border-gray-200"})]}),(0,t.jsxs)("div",{className:"sm:col-span-2",children:[(0,t.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Contenido (usa placeholders: ","{{nombre}}",", ","{{curso}}",", ","{{fecha}}",")"]}),(0,t.jsx)("textarea",{value:k,onChange:e=>E(e.target.value),placeholder:"Redacta tu plantilla. Ej: Hola {{nombre}}, te informamos que...",className:"w-full px-4 py-3 border rounded-lg text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent border-gray-200 resize-none h-32 sm:h-36"})]})]}),(0,t.jsx)("div",{className:"sm:col-span-2 flex justify-end",children:(0,t.jsx)("button",{type:"button",onClick:()=>{C.trim()&&k.trim()&&d.x.createTemplate({name:C.trim(),content:k.trim()}).then(e=>{let s=e.data;g(e=>[s,...e]),S(""),E(""),v(s.id),w(s.content)}).catch(()=>{})},className:"px-5 py-2.5 bg-primary text-white rounded-lg font-semibold hover:bg-primary-dark transition-colors",children:"Agregar plantilla"})})]})]})}),(0,t.jsx)(o.u_,{isOpen:F,title:"Editar plantilla",onClose:sc,onConfirm:()=>{L&&I.trim()&&z.trim()&&d.x.updateTemplate(L,{name:I.trim(),content:z.trim()}).then(e=>{let s=e.data;g(e=>e.map(e=>e.id===s.id?s:e)),j===s.id&&(w(s.content),$(s.name)),sc()}).catch(()=>{})},confirmText:"Guardar cambios",children:(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nombre"}),(0,t.jsx)("input",{type:"text",value:I,onChange:e=>P(e.target.value),className:"w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent border-gray-200"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Contenido"}),(0,t.jsx)("textarea",{value:z,onChange:e=>T(e.target.value),className:"w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent border-gray-200 resize-none h-28"})]})]})}),(0,t.jsx)(o.u_,{isOpen:!!B,title:"Eliminar plantilla",onClose:()=>{_(null)},onConfirm:()=>{B&&d.x.deleteTemplate(B.id).then(()=>{g(e=>e.filter(e=>e.id!==B.id)),j===B.id&&v(null),L===B.id&&sc(),_(null)}).catch(()=>{})},confirmText:"Eliminar",children:(0,t.jsxs)("p",{className:"text-sm text-gray-700",children:["\xbfDeseas eliminar la plantilla"," ",(0,t.jsx)("span",{className:"font-semibold",children:null==B?void 0:B.name}),"? Esta acci\xf3n no se puede deshacer."]})})]}):(0,t.jsx)(i.I,{children:(0,t.jsxs)("div",{className:"max-w-3xl mx-auto glass-panel rounded-2xl p-6 soft-shadow",children:[(0,t.jsx)("h1",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Sin permisos"}),(0,t.jsx)("p",{className:"text-gray-600",children:"No tienes permisos para crear mensajes. Si crees que es un error, contacta al administrador."}),(0,t.jsxs)("div",{className:"mt-4 flex gap-3",children:[(0,t.jsx)(l.default,{href:"/messages",className:"inline-flex px-4 py-2 rounded-lg bg-primary text-white text-sm font-medium hover:bg-primary-dark transition-colors",children:"Ver historial"}),(0,t.jsx)(l.default,{href:"/dashboard",className:"inline-flex px-4 py-2 rounded-lg border border-gray-300 text-gray-700 text-sm font-medium hover:bg-gray-50 transition-colors",children:"Ir al dashboard"})]})]})})}}},function(e){e.O(0,[502,619,648,785,255,462,971,117,744],function(){return e(e.s=7348)}),_N_E=e.O()}]);